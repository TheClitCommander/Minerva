<!DOCTYPE html>
<html>
<head>
    <title>Minerva Think Tank Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #111;
            color: #f0f0f0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: url('https://images.unsplash.com/photo-1543722530-d2c3201371e7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2574&q=80');
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }
        
        /* Chat Interface */
        #chat-interface {
            position: absolute;
            width: 400px;
            height: 500px;
            background-color: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            z-index: 1000;
            right: 30px;
            bottom: 30px;
        }
        
        #chat-interface.minimized {
            height: 48px;
            overflow: hidden;
        }
        
        /* Chat Header */
        #chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: rgba(30, 41, 59, 0.8);
            border-bottom: 1px solid rgba(100, 116, 139, 0.3);
            cursor: move;
        }
        
        #chat-title {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        #chat-controls {
            display: flex;
            gap: 8px;
        }
        
        .chat-control-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .chat-control-btn:hover {
            color: #e2e8f0;
            background-color: rgba(100, 116, 139, 0.2);
        }
        
        /* Chat messages container */
        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            scroll-behavior: smooth;
            color: #e2e8f0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Chat input area */
        #chat-input-container {
            display: flex;
            padding: 12px;
            background-color: rgba(30, 41, 59, 0.5);
            border-top: 1px solid rgba(100, 116, 139, 0.3);
            gap: 8px;
        }
        
        #chat-input {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid rgba(100, 116, 139, 0.5);
            background-color: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
            resize: none;
            overflow-y: auto;
            outline: none;
            transition: border-color 0.2s;
            font-family: inherit;
            font-size: 14px;
        }
        
        #chat-input:focus {
            border-color: #3b82f6;
        }
        
        #send-message {
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 0;
            font-size: 16px;
        }
        
        #send-message:hover {
            background-color: #2563eb;
        }
        
        /* Message styles */
        .user-message {
            background-color: rgba(59, 130, 246, 0.15);
            border-radius: 8px;
            padding: 10px 15px;
            margin: 8px 0;
            align-self: flex-end;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .ai-message {
            background-color: rgba(30, 41, 59, 0.4);
            border-radius: 8px;
            padding: 10px 15px;
            margin: 8px 0;
            align-self: flex-start;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .system-message {
            color: #94a3b8;
            font-style: italic;
            text-align: center;
            margin: 8px 0;
            font-size: 12px;
        }
        
        /* Loading indicator */
        .loading-indicator {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: rgba(30, 41, 59, 0.4);
            border-radius: 8px;
            margin: 8px 0;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        /* Model info below AI responses */
        .model-info {
            font-size: 0.8em;
            margin-top: 5px;
            color: rgba(255, 255, 255, 0.7);
        }
    </style>
</head>
<body>    
    <!-- Chat Interface (Think Tank) -->
    <div id="chat-interface">
        <!-- Chat header with controls -->
        <div id="chat-header">
            <div id="chat-title">Minerva Think Tank</div>
            <div id="chat-controls">
                <button class="chat-control-btn" id="minimize-chat" title="Minimize chat"><i class="fas fa-minus"></i></button>
            </div>
        </div>
        
        <!-- Chat messages container -->
        <div id="chat-messages">
            <div class="system-message">Welcome to Minerva Think Tank. How can I assist you today?</div>
        </div>
        
        <!-- Chat input area -->
        <div id="chat-input-container">
            <textarea id="chat-input" placeholder="Type your message here..." rows="1"></textarea>
            <button id="send-message"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    
    <script>
        // Initialize the chat interface
        function initChatInterface() {
            const chatInterface = document.getElementById('chat-interface');
            const chatHeader = document.getElementById('chat-header');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-message');
            const minimizeBtn = document.getElementById('minimize-chat');
            
            // Make chat interface draggable
            makeDraggable(chatInterface, chatHeader);
            
            // Set up minimize button
            if (minimizeBtn) {
                minimizeBtn.addEventListener('click', function() {
                    chatInterface.classList.toggle('minimized');
                    const icon = this.querySelector('i');
                    if (icon) {
                        if (chatInterface.classList.contains('minimized')) {
                            icon.classList.remove('fa-minus');
                            icon.classList.add('fa-expand');
                            this.setAttribute('title', 'Expand chat');
                        } else {
                            icon.classList.remove('fa-expand');
                            icon.classList.add('fa-minus');
                            this.setAttribute('title', 'Minimize chat');
                        }
                    }
                });
            }
            
            // Set up chat input and send button
            if (sendButton && chatInput) {
                sendButton.addEventListener('click', sendMessage);
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // Function to send a message
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // Add user message to chat
                addUserMessage(message);
                chatInput.value = '';
                
                // Get AI response from Think Tank
                getAIResponse(message);
            }
            
            // Function to add a user message to the chat
            function addUserMessage(message) {
                const msgElement = document.createElement('div');
                msgElement.className = 'user-message';
                msgElement.textContent = message;
                chatMessages.appendChild(msgElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Function to add an AI message to the chat
            function addAIMessage(message, modelInfo = null) {
                const msgElement = document.createElement('div');
                msgElement.className = 'ai-message';
                
                // Create the main response container
                const responseContainer = document.createElement('div');
                responseContainer.className = 'response-content';
                responseContainer.innerHTML = message.replace(/\n/g, '<br>');
                msgElement.appendChild(responseContainer);
                
                // Add model info if provided
                if (modelInfo) {
                    const infoElement = document.createElement('div');
                    infoElement.className = 'model-info';
                    let modelText = '';
                    
                    if (typeof modelInfo === 'object' && modelInfo.primary_model) {
                        // Use primary model name
                        modelText = modelInfo.primary_model;
                    } else if (Array.isArray(modelInfo)) {
                        // If we have multiple models, join them with commas
                        modelText = modelInfo.join(', ');
                    } else if (typeof modelInfo === 'string') {
                        // If it's a single string, use it directly
                        modelText = modelInfo;
                    } else {
                        // Default to Think Tank
                        modelText = 'Think Tank';
                    }
                    
                    infoElement.innerHTML = `<small>Powered by ${modelText}</small>`;
                    msgElement.appendChild(infoElement);
                }
                
                chatMessages.appendChild(msgElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Function to get a real AI response using the Think Tank API
            async function getAIResponse(userMessage) {
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'loading-indicator';
                loadingIndicator.innerHTML = 'Minerva is thinking...';
                chatMessages.appendChild(loadingIndicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                try {
                    console.log('Processing user message:', userMessage);
                    
                    // Generate a conversation ID if needed
                    const conversationId = generateConversationId();
                    console.log('Using conversation ID:', conversationId);
                    
                    let data;
                    
                    // Use the Think Tank API
                    console.log('Sending request to Think Tank API...');
                    const response = await fetch('http://localhost:8888/api/think-tank', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Session-ID': conversationId
                        },
                        body: JSON.stringify({
                            message: userMessage,
                            conversation_id: conversationId
                        })
                    });
                    
                    // Check if the response was successful
                    if (!response.ok) {
                        console.error(`API Error: ${response.status} - ${response.statusText}`);
                        throw new Error(`Think Tank API Error (${response.status})`);
                    }
                    
                    // Parse the response data
                    data = await response.json();
                    console.log('API Response:', data);
                    
                    // Remove loading indicator
                    if (chatMessages.contains(loadingIndicator)) {
                        chatMessages.removeChild(loadingIndicator);
                    }
                    
                    // Add AI response to chat with model info
                    addAIMessage(data.response, data.model_info);
                    
                } catch (error) {
                    console.error('Error fetching AI response:', error);
                    
                    // Remove loading indicator
                    if (chatMessages.contains(loadingIndicator)) {
                        chatMessages.removeChild(loadingIndicator);
                    }
                    
                    // Display error message
                    addAIMessage(`I'm sorry, but I encountered an error while processing your request. Please try again later.`, 'System');
                }
            }
            
            // Generate a consistent conversation ID
            function generateConversationId() {
                if (!window.conversationId) {
                    window.conversationId = 'conv-' + Date.now() + '-' + Math.random().toString(36).substring(2, 10);
                }
                return window.conversationId;
            }
        }
        
        // Make an element draggable
        function makeDraggable(element, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            if (handle) {
                // If a handle is provided, use it
                handle.onmousedown = dragMouseDown;
            } else {
                // Otherwise use the entire element as handle
                element.onmousedown = dragMouseDown;
            }
            
            function dragMouseDown(e) {
                e = e || window.event;
                
                // Don't start dragging if clicked on a button or input
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'TEXTAREA' || 
                    e.target.tagName === 'INPUT' || e.target.tagName === 'I') {
                    return;
                }
                
                e.preventDefault();
                
                // Get the mouse cursor position at startup
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                // Add dragging class
                element.classList.add('dragging');
                
                // Stop animations during drag
                element.style.transition = 'none';
                
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                
                // Calculate the new cursor position
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                // Calculate new position
                const newTop = element.offsetTop - pos2;
                const newLeft = element.offsetLeft - pos1;
                
                // Ensure the element stays within the viewport
                const maxX = window.innerWidth - element.offsetWidth;
                const maxY = window.innerHeight - element.offsetHeight;
                
                element.style.top = Math.min(maxY, Math.max(0, newTop)) + "px";
                element.style.left = Math.min(maxX, Math.max(0, newLeft)) + "px";
                
                // Reset right/bottom properties since we're using top/left
                element.style.right = 'auto';
                element.style.bottom = 'auto';
            }
            
            function closeDragElement() {
                // Stop moving when mouse button is released
                document.onmouseup = null;
                document.onmousemove = null;
                
                // Remove dragging class
                element.classList.remove('dragging');
                
                // Restore animations
                element.style.transition = '';
            }
        }
        
        // Initialize the chat interface when the page loads
        document.addEventListener('DOMContentLoaded', initChatInterface);
    </script>
</body>
</html>
