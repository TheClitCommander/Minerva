<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minerva Socket.IO Diagnostics</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        #status {
            padding: 10px;
            border-radius: 4px;
            margin: 20px 0;
            font-weight: bold;
        }
        .connected { 
            background-color: #d4edda; 
            color: #155724;
        }
        .disconnected { 
            background-color: #f8d7da; 
            color: #721c24;
        }
        .connecting { 
            background-color: #fff3cd; 
            color: #856404;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .log .info { color: #0c5460; }
        .log .error { color: #721c24; }
        .log .success { color: #155724; }
        .log .warn { color: #856404; }
        .input-group {
            display: flex;
            margin-bottom: 20px;
        }
        input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        button:hover {
            background-color: #0069d9;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Minerva Socket.IO Diagnostics</h1>
    <div id="status" class="connecting">Connecting...</div>
    
    <div class="input-group">
        <input type="text" id="message" placeholder="Type a message to test chat">
        <button id="send" disabled>Send</button>
    </div>
    
    <h3>Event Log</h3>
    <div id="log" class="log"></div>
    
    <div class="input-group">
        <input type="text" id="event" placeholder="Event name (e.g., 'debug')">
        <button id="emit-event">Emit Event</button>
    </div>
    
    <script>
        // DOM Elements
        const statusElement = document.getElementById('status');
        const logElement = document.getElementById('log');
        const messageInput = document.getElementById('message');
        const sendButton = document.getElementById('send');
        const eventInput = document.getElementById('event');
        const emitEventButton = document.getElementById('emit-event');
        
        // Log function
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // Initialize Socket.IO
        log('Initializing Socket.IO connection...');
        
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            timeout: 20000,
            transports: ['websocket', 'polling']
        });
        
        // Connection events
        socket.on('connect', () => {
            log('Socket.IO CONNECTED ✅', 'success');
            statusElement.textContent = 'Connected ✅';
            statusElement.className = 'connected';
            sendButton.disabled = false;
            
            // Send debug ping
            socket.emit('debug', {
                client: 'diagnostic-tool',
                timestamp: Date.now(),
                ua: navigator.userAgent
            });
            log('Sent debug ping');
        });
        
        socket.on('disconnect', () => {
            log('Socket.IO DISCONNECTED ❌', 'error');
            statusElement.textContent = 'Disconnected ❌';
            statusElement.className = 'disconnected';
            sendButton.disabled = true;
        });
        
        socket.on('connect_error', (error) => {
            log(`Socket.IO CONNECTION ERROR: ${error}`, 'error');
            statusElement.textContent = 'Connection Error ❌';
            statusElement.className = 'disconnected';
            sendButton.disabled = true;
        });
        
        // Response events
        socket.on('message', (data) => {
            log(`Received 'message' event: ${JSON.stringify(data)}`, 'info');
        });
        
        socket.on('chat_reply', (data) => {
            log(`Received 'chat_reply' event: ${JSON.stringify(data)}`, 'success');
        });
        
        socket.on('response', (data) => {
            log(`Received 'response' event: ${JSON.stringify(data)}`, 'info');
        });
        
        socket.on('system_message', (data) => {
            log(`Received 'system_message': ${JSON.stringify(data)}`, 'warn');
        });
        
        socket.on('debug_response', (data) => {
            log(`Received 'debug_response': ${JSON.stringify(data)}`, 'info');
        });
        
        // Catch all events for comprehensive logging
        const originalOnEvent = socket.onevent;
        socket.onevent = function(packet) {
            const eventName = packet.data[0];
            if (!['message', 'chat_reply', 'response', 'system_message', 'debug_response'].includes(eventName)) {
                log(`Received '${eventName}' event: ${JSON.stringify(packet.data.slice(1))}`, 'info');
            }
            return originalOnEvent.apply(this, arguments);
        };
        
        // Send button handler
        sendButton.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message) {
                log(`Sending chat_message: ${message}`, 'info');
                
                // Try both event names for maximum compatibility
                socket.emit('chat_message', { text: message });
                
                // Also try the alternate format
                setTimeout(() => {
                    socket.emit('message', message);
                }, 100);
                
                messageInput.value = '';
            }
        });
        
        // Enter key to send
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendButton.click();
            }
        });
        
        // Custom event emitter
        emitEventButton.addEventListener('click', () => {
            const eventName = eventInput.value.trim();
            if (eventName) {
                log(`Emitting custom event: ${eventName}`, 'info');
                socket.emit(eventName, { text: 'Test payload', timestamp: Date.now() });
            }
        });
    </script>
</body>
</html>
