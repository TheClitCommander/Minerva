<!DOCTYPE html>
<html>
<head>
    <title>Minerva Assistant with Think Tank Integration</title>
    <style>
        /* Base styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #0a192f;
            color: #e6f1ff;
        }
        
        /* Main content */
        .content {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            color: #64ffda;
        }
        
        /* Floating chat container */
        #floating-chat {
            position: fixed;
            bottom: 80px;
            right: 30px;
            width: 380px;
            max-height: 500px;
            background-color: rgba(13, 25, 50, 0.85);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        #floating-chat.minimized {
            height: 50px;
            overflow: hidden;
        }
        
        /* Chat header */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: rgba(23, 42, 69, 0.8);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            cursor: move;
        }
        
        .chat-title {
            font-weight: 600;
            font-size: 16px;
            color: #e6f1ff;
        }
        
        .chat-controls {
            display: flex;
        }
        
        .chat-control-btn {
            background: none;
            border: none;
            color: #8892b0;
            cursor: pointer;
            padding: 4px;
            margin-left: 8px;
            font-size: 16px;
            transition: color 0.2s;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-control-btn:hover {
            color: #64ffda;
        }
        
        /* Chat messages area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 350px;
        }
        
        .message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 15px;
            line-height: 1.4;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: #64ffda;
            color: #0a192f;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .bot-message {
            background-color: rgba(31, 58, 93, 0.6);
            color: #e6f1ff;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .system-message {
            background-color: rgba(100, 255, 218, 0.1);
            color: #8892b0;
            align-self: center;
            font-style: italic;
            font-size: 12px;
            padding: 8px 12px;
            text-align: center;
        }
        
        /* Model info for bot messages */
        .model-info {
            font-size: 10px;
            color: #8892b0;
            margin-top: 5px;
            text-align: right;
        }
        
        /* Chat input area */
        .chat-input-container {
            border-top: 1px solid rgba(100, 255, 218, 0.1);
            padding: 12px 15px;
            display: flex;
            background-color: rgba(17, 34, 64, 0.8);
        }
        
        .chat-input {
            flex: 1;
            border: none;
            background-color: rgba(255, 255, 255, 0.05);
            color: #e6f1ff;
            padding: 10px 15px;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }
        
        .chat-input:focus {
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.3);
        }
        
        .chat-send {
            background-color: #64ffda;
            color: #0a192f;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .chat-send:hover {
            background-color: #72ffdd;
        }
        
        /* Chat toggle button (fixed at bottom right) */
        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: #64ffda;
            color: #0a192f;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 1001;
        }
        
        .chat-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        
        /* Chat typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 5px 12px;
            background-color: rgba(31, 58, 93, 0.4);
            border-radius: 15px;
            align-self: flex-start;
            max-width: 55px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #64ffda;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing-dot 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing-dot {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-5px);
                opacity: 1;
            }
        }
        
        /* Project conversion container */
        .project-conversion {
            background-color: rgba(31, 58, 93, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            align-self: stretch;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .project-conversion h3 {
            margin: 0 0 10px;
            font-size: 16px;
            color: #64ffda;
        }
        
        .project-conversion p {
            margin: 0 0 12px;
            font-size: 14px;
            color: #e6f1ff;
        }
        
        .project-input {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 5px;
            color: #e6f1ff;
            font-size: 14px;
        }
        
        .project-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .project-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .create-project {
            background-color: #64ffda;
            color: #0a192f;
            flex: 1;
            margin-right: 10px;
        }
        
        .create-project:hover {
            background-color: #72ffdd;
        }
        
        .dismiss-project {
            background-color: rgba(255, 255, 255, 0.1);
            color: #e6f1ff;
        }
        
        .dismiss-project:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Feature section */
        .feature-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .feature-card {
            background-color: rgba(23, 42, 69, 0.8);
            padding: 25px;
            border-radius: 8px;
            transition: transform 0.3s;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
        }
        
        .feature-card h2 {
            color: #64ffda;
            margin-top: 0;
        }
        
        .feature-card p {
            color: #8892b0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="content">
        <h1>Minerva Project Space</h1>
        <div class="feature-section">
            <div class="feature-card">
                <h2>Think Tank Integration</h2>
                <p>Access the full power of Minerva's Think Tank to get answers from multiple AI models blended for optimal results.</p>
            </div>
            <div class="feature-card">
                <h2>Conversation Memory</h2>
                <p>Your chat conversations are remembered across sessions, allowing for continuous work even if you navigate away.</p>
            </div>
            <div class="feature-card">
                <h2>Project Conversion</h2>
                <p>Turn any helpful conversation directly into a project with a single click, preserving all context and information.</p>
            </div>
        </div>
    </div>
    
    <!-- Floating Chat -->
    <button class="chat-toggle" id="chat-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    </button>
    
    <div id="floating-chat" class="minimized">
        <div class="chat-header" id="chat-header">
            <div class="chat-title">Minerva Assistant</div>
            <div class="chat-controls">
                <button class="chat-control-btn" id="chat-minimize">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chat-input" placeholder="Ask Minerva..." aria-label="Chat message">
            <button class="chat-send" id="chat-send">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </div>
    
    <!-- Connector Script - handles the connection to the Think Tank API -->
    <script src="/static/js/chat/chat-connector.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // DOM elements
            const chatContainer = document.getElementById('floating-chat');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');
            const chatToggle = document.getElementById('chat-toggle');
            const chatMinimize = document.getElementById('chat-minimize');
            const chatHeader = document.getElementById('chat-header');
            
            // Dragging functionality
            let isDragging = false;
            let dragOffsetX, dragOffsetY;
            
            // Utility to get URL parameters
            function getUrlParameter(name) {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                const results = regex.exec(location.search);
                return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
            }
            
            // Get project context if available
            const projectId = getUrlParameter('id');
            
            // Generate a conversation ID for this session or retrieve existing
            const conversationId = localStorage.getItem('minerva_conversation_id') || 'conv-' + Date.now();
            localStorage.setItem('minerva_conversation_id', conversationId);
            
            console.log("Active conversation ID:", conversationId);
            
            // Toggle chat open/closed
            function toggleChat() {
                chatContainer.classList.toggle('minimized');
                if (!chatContainer.classList.contains('minimized')) {
                    chatInput.focus();
                    
                    // If this is first opening, show welcome message
                    if (chatMessages.childElementCount === 0) {
                        // Welcome message
                        const welcomeMsg = projectId ? 
                            `Hello! I'm your Minerva Assistant for project #${projectId}. How can I help with this project today?` :
                            "Hello! I'm your Minerva Assistant. I'm connected to the Think Tank for real, intelligent answers. How can I help you today?";
                        
                        addBotMessage(welcomeMsg, {
                            primary_model: "Minerva",
                            processing_time: 0
                        });
                    }
                }
            }
            
            // Add a user message to the chat
            function addUserMessage(text) {
                const messageEl = document.createElement('div');
                messageEl.className = 'message user-message';
                messageEl.textContent = text;
                chatMessages.appendChild(messageEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Add a bot message to the chat
            function addBotMessage(text, modelInfo = null) {
                const messageEl = document.createElement('div');
                messageEl.className = 'message bot-message';
                
                // Create the message content
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.textContent = text;
                messageEl.appendChild(messageContent);
                
                // Add model info if available
                if (modelInfo) {
                    const modelInfoEl = document.createElement('div');
                    modelInfoEl.className = 'model-info';
                    
                    // Determine what to show for model info
                    let modelText = 'Powered by ';
                    if (modelInfo.primary_model) {
                        modelText += modelInfo.primary_model;
                    } else if (modelInfo.models && modelInfo.models.length) {
                        modelText += modelInfo.models[0];
                    } else {
                        modelText += 'Think Tank';
                    }
                    
                    // Add processing time if available
                    if (modelInfo.processing_time) {
                        modelText += ` (${modelInfo.processing_time.toFixed(2)}s)`;
                    }
                    
                    modelInfoEl.textContent = modelText;
                    messageEl.appendChild(modelInfoEl);
                }
                
                chatMessages.appendChild(messageEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Check if we should offer to convert to project
                if (!projectId && text.length > 150) {
                    // Only offer for substantive conversations to avoid clutter
                    setTimeout(() => {
                        showProjectConversion();
                    }, 1000);
                }
            }
            
            // Add a system message to the chat
            function addSystemMessage(text) {
                const messageEl = document.createElement('div');
                messageEl.className = 'message system-message';
                messageEl.textContent = text;
                chatMessages.appendChild(messageEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Add typing indicator
            function addTypingIndicator() {
                // Remove any existing typing indicators
                removeTypingIndicator();
                
                const indicator = document.createElement('div');
                indicator.className = 'typing-indicator';
                indicator.id = 'typing-indicator';
                
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'typing-dot';
                    indicator.appendChild(dot);
                }
                
                chatMessages.appendChild(indicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return indicator;
            }
            
            // Remove typing indicator
            function removeTypingIndicator() {
                const existing = document.getElementById('typing-indicator');
                if (existing) {
                    existing.remove();
                }
            }
            
            // Show project conversion UI
            function showProjectConversion() {
                // Check if conversion is already shown
                if (document.querySelector('.project-conversion')) {
                    return;
                }
                
                const conversionDiv = document.createElement('div');
                conversionDiv.className = 'project-conversion';
                conversionDiv.innerHTML = `
                    <h3>Create a Project</h3>
                    <p>Save this conversation as a project to continue working on it later.</p>
                    <input type="text" id="project-name-input" class="project-input" placeholder="Project name">
                    <div class="project-buttons">
                        <button id="create-project-btn" class="project-btn create-project">Create Project</button>
                        <button id="dismiss-project-btn" class="project-btn dismiss-project">Dismiss</button>
                    </div>
                `;
                
                chatMessages.appendChild(conversionDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Auto-focus the input field
                setTimeout(() => {
                    const inputField = document.getElementById('project-name-input');
                    if (inputField) inputField.focus();
                }, 100);
                
                // Add event listener to dismiss button
                document.getElementById('dismiss-project-btn').addEventListener('click', () => {
                    conversionDiv.remove();
                });
                
                // Add event listener to create project button
                document.getElementById('create-project-btn').addEventListener('click', () => {
                    const projectName = document.getElementById('project-name-input').value.trim();
                    if (!projectName) {
                        alert('Please enter a project name');
                        return;
                    }
                    
                    const createBtn = document.getElementById('create-project-btn');
                    createBtn.textContent = 'Creating...';
                    createBtn.disabled = true;
                    
                    // Determine correct API endpoint
                    let apiUrl = '/api/projects/create-from-conversation';
                    if (window.location.port === '52952') {
                        apiUrl = '/api/projects/create-from-conversation';
                    } else {
                        apiUrl = 'http://127.0.0.1:52952/api/projects/create-from-conversation';
                    }
                    
                    // Save current conversation to ensure all messages are preserved
                    localStorage.setItem(`minerva_conversation_${conversationId}_name`, projectName);
                    
                    fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            conversation_id: conversationId,
                            project_name: projectName,
                            include_memory: true // Ensure all conversation memory is included
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.project_id) {
                            conversionDiv.innerHTML = `
                                <h3>Project Created!</h3>
                                <p>Your project "${projectName}" has been created successfully.</p>
                                <div class="project-buttons">
                                    <a href="/project?id=${data.project_id}" class="project-btn create-project">View Project</a>
                                </div>
                            `;
                        } else {
                            throw new Error(data.error || 'Failed to create project');
                        }
                    })
                    .catch(error => {
                        console.error('Error creating project:', error);
                        
                        // Store locally even if API fails
                        const localProjects = JSON.parse(localStorage.getItem('minerva_local_projects') || '[]');
                        const newProject = {
                            id: 'local-' + Date.now(),
                            name: projectName,
                            conversation_id: conversationId,
                            created_at: new Date().toISOString()
                        };
                        
                        localProjects.push(newProject);
                        localStorage.setItem('minerva_local_projects', JSON.stringify(localProjects));
                        
                        conversionDiv.innerHTML = `
                            <h3>Project Saved Locally</h3>
                            <p>Your project "${projectName}" has been saved locally. The server connection failed, but your project data is preserved.</p>
                            <div class="project-buttons">
                                <button id="dismiss-success-btn" class="project-btn create-project">Okay</button>
                            </div>
                        `;
                        
                        document.getElementById('dismiss-success-btn').addEventListener('click', () => {
                            conversionDiv.remove();
                        });
                    });
                });
            }
            
            // Send message to Think Tank API
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // Clear input
                chatInput.value = '';
                
                // Add user message to chat
                addUserMessage(message);
                
                // Add typing indicator
                const typingIndicator = addTypingIndicator();
                
                // Use the chat connector to send message
                window.MinervaChat.sendMessage(
                    message,
                    conversationId,
                    // Success callback
                    (data) => {
                        // Remove typing indicator
                        removeTypingIndicator();
                        
                        // Extract response and model info
                        const responseText = window.MinervaChat.extractResponseText(data);
                        const modelInfo = window.MinervaChat.extractModelInfo(data);
                        
                        // Save new conversation ID if provided
                        if (data.conversation_id) {
                            localStorage.setItem('minerva_conversation_id', data.conversation_id);
                        }
                        
                        // Display bot response
                        addBotMessage(responseText, modelInfo);
                    },
                    // Error callback
                    (error) => {
                        console.error("Error sending message:", error);
                        removeTypingIndicator();
                        addSystemMessage("Sorry, I couldn't connect to the Think Tank. Please try again later.");
                    },
                    // Typing callback
                    (isTyping) => {
                        if (isTyping) {
                            if (!document.getElementById('typing-indicator')) {
                                addTypingIndicator();
                            }
                        } else {
                            removeTypingIndicator();
                        }
                    }
                );
            }
            
            // Event listener for send button
            chatSend.addEventListener('click', sendMessage);
            
            // Event listener for enter key
            chatInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Event listeners for chat toggle
            chatToggle.addEventListener('click', toggleChat);
            chatMinimize.addEventListener('click', toggleChat);
            
            // Dragging functionality
            chatHeader.addEventListener('mousedown', (e) => {
                isDragging = true;
                dragOffsetX = e.clientX - chatContainer.getBoundingClientRect().left;
                dragOffsetY = e.clientY - chatContainer.getBoundingClientRect().top;
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                
                // Prevent text selection during drag
                e.preventDefault();
            });
            
            function onMouseMove(e) {
                if (!isDragging) return;
                
                const x = e.clientX - dragOffsetX;
                const y = e.clientY - dragOffsetY;
                
                chatContainer.style.left = `${x}px`;
                chatContainer.style.top = `${y}px`;
                chatContainer.style.right = 'auto';
                chatContainer.style.bottom = 'auto';
            }
            
            function onMouseUp() {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        });
    </script>
</body>
</html>
