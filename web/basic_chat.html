<!DOCTYPE html>
<html>
<head>
    <title>Minerva Basic Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #chat-interface {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background-color: #1e293b;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #chat-header {
            padding: 16px;
            background-color: #2d3748;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }
        
        #chat-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
        }
        
        .header-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 16px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .header-btn:hover {
            color: #e2e8f0;
        }
        
        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .user-message, .ai-message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
        }
        
        .ai-message {
            background-color: #334155;
            color: #e2e8f0;
            align-self: flex-start;
        }
        
        .ai-message .response-content {
            margin-bottom: 8px;
        }
        
        .model-info {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #475569;
        }
        
        .model-badge {
            display: inline-block;
            padding: 2px 6px;
            background-color: #4f46e5;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 4px;
        }
        
        .loading-indicator {
            padding: 12px;
            background-color: #334155;
            color: #94a3b8;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            align-self: flex-start;
        }
        
        #chat-input-container {
            padding: 16px;
            background-color: #2d3748;
            display: flex;
            gap: 12px;
        }
        
        #chat-input {
            flex: 1;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #475569;
            background-color: #1e293b;
            color: #e2e8f0;
            font-family: inherit;
            resize: none;
            outline: none;
            height: 40px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        #send-message {
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #send-message:hover {
            background-color: #2563eb;
        }
    </style>
</head>
<body>
    <!-- Chat Interface -->
    <div id="chat-interface">
        <div id="chat-header">
            <h2>Minerva Think Tank Chat</h2>
            <div class="header-actions">
                <button id="toggle-metrics" class="header-btn" title="Show model metrics">
                    <i class="fas fa-chart-bar"></i>
                </button>
                <button id="minimize-chat" class="header-btn" title="Minimize chat">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-container">
            <textarea id="chat-input" placeholder="Type your message here..."></textarea>
            <button id="send-message"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    
    <script>
        // Initialize the chat interface
        function initChatInterface() {
            // Get DOM elements
            const chatInterface = document.getElementById('chat-interface');
            const chatHeader = document.getElementById('chat-header');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-message');
            const minimizeBtn = document.getElementById('minimize-chat');
            
            // Set up minimize button
            if (minimizeBtn) {
                minimizeBtn.addEventListener('click', function() {
                    chatInterface.classList.toggle('minimized');
                });
            }
            
            // Set up chat input and send button
            if (sendButton && chatInput) {
                sendButton.addEventListener('click', sendMessage);
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // Function to send a message
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // Add user message to chat
                addUserMessage(message);
                chatInput.value = '';
                
                // Get real AI response from Think Tank
                getAIResponse(message);
            }
            
            // Function to add a user message to the chat
            function addUserMessage(message) {
                const msgElement = document.createElement('div');
                msgElement.className = 'user-message';
                msgElement.textContent = message;
                chatMessages.appendChild(msgElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Function to add an AI message to the chat
            function addAIMessage(message, modelInfo = null) {
                const msgElement = document.createElement('div');
                msgElement.className = 'ai-message';
                
                // Create the main response container
                const responseContainer = document.createElement('div');
                responseContainer.className = 'response-content';
                responseContainer.innerHTML = message.replace(/\n/g, '<br>');
                msgElement.appendChild(responseContainer);
                
                // Add model info if provided
                if (modelInfo) {
                    const infoElement = document.createElement('div');
                    infoElement.className = 'model-info';
                    
                    // Check if we have enhanced model_info object
                    if (typeof modelInfo === 'object' && !Array.isArray(modelInfo)) {
                        // Create detailed model info display
                        let modelHTML = '<div class="model-details">';
                        
                        // Show primary model
                        const primaryModel = modelInfo.primary_model || 'Think Tank';
                        modelHTML += `<div class="primary-model">Primary Model: <strong>${primaryModel}</strong></div>`;
                        
                        // Show model contributions if available
                        if (modelInfo.models_used && Array.isArray(modelInfo.models_used) && modelInfo.models_used.length > 0) {
                            modelHTML += '<div class="model-contributions">Models Used: ';
                            
                            // Handle both string and object formats
                            const colors = ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#EC4899'];
                            if (typeof modelInfo.models_used[0] === 'string') {
                                // Array of strings
                                modelInfo.models_used.forEach((model, index) => {
                                    const color = colors[index % colors.length];
                                    modelHTML += `<span class="model-badge" style="background-color: ${color}">${model}</span>`;
                                });
                            } else {
                                // Array of objects
                                modelInfo.models_used.forEach((model, index) => {
                                    const modelName = model.name || 'Unknown';
                                    const contribution = model.contribution ? `${model.contribution}%` : '';
                                    const color = model.color || '#3B82F6';
                                    modelHTML += `<span class="model-badge" style="background-color: ${color}">${modelName} ${contribution}</span>`;
                                });
                            }
                            modelHTML += '</div>';
                        }
                        
                        modelHTML += '</div>';
                        infoElement.innerHTML = modelHTML;
                    } else {
                        // Fall back to simple model display
                        let modelText = '';
                        
                        if (Array.isArray(modelInfo)) {
                            // If we have multiple models, join them with commas
                            modelText = modelInfo.join(', ');
                        } else if (typeof modelInfo === 'string') {
                            // If it's a single string, use it directly
                            modelText = modelInfo;
                        } else {
                            // Default to Think Tank
                            modelText = 'Think Tank';
                        }
                        
                        const isMultiple = Array.isArray(modelInfo) && modelInfo.length > 1;
                        infoElement.innerHTML = `<small>Powered by ${isMultiple ? 'multiple AI models' : 'AI model'}: ${modelText}</small>`;
                    }
                    
                    msgElement.appendChild(infoElement);
                }
                
                chatMessages.appendChild(msgElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Function to get a real AI response using the Think Tank processor
            async function getAIResponse(userMessage) {
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'loading-indicator';
                loadingIndicator.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Minerva is thinking...';
                chatMessages.appendChild(loadingIndicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                try {
                    console.log('Processing user message:', userMessage);
                    
                    // Generate a conversation ID if needed
                    const conversationId = 'simple-test-' + Math.random().toString(36).substring(2, 15);
                    console.log('Using conversation ID:', conversationId);
                    
                    let data;
                    
                    // Use the real Think Tank API
                    console.log('Sending request to Think Tank API...');
                    const response = await fetch('/api/think-tank', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Session-ID': conversationId
                        },
                        body: JSON.stringify({
                            message: userMessage,
                            conversation_id: conversationId,
                            model_preferences: {
                                include_detailed_rankings: true,
                                include_model_contributions: true,
                                include_capability_scores: true,
                                include_blending_details: true,
                                blend_responses: true
                            }
                        })
                    });
                    
                    // Check if the response was successful
                    if (!response.ok) {
                        console.error(`API Error: ${response.status} - ${response.statusText}`);
                        throw new Error(`Think Tank API Error (${response.status})`);
                    }
                    
                    // Parse the response data
                    try {
                        data = await response.json();
                        console.log('API Response:', data);
                    } catch (parseError) {
                        console.error('Error parsing API response:', parseError);
                        throw new Error('Invalid response from Think Tank API');
                    }
                    
                    // Remove loading indicator
                    if (chatMessages.contains(loadingIndicator)) {
                        chatMessages.removeChild(loadingIndicator);
                    }
                    
                    // Add AI message to chat
                    addAIMessage(data.response, data.model_info);
                    
                } catch (error) {
                    console.error('Error fetching AI response:', error);
                    
                    // Remove loading indicator
                    if (chatMessages.contains(loadingIndicator)) {
                        chatMessages.removeChild(loadingIndicator);
                    }
                    
                    // Display a friendly error message
                    addAIMessage("I apologize, but I encountered an error while processing your request. Please try again.", ["System"]);
                }
            }
        }

        // Initialize the chat interface
        initChatInterface();
    </script>
</body>
</html>
