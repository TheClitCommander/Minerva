{% extends "base.html" %}

{% block title %}Minerva AI - Memories{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-brain me-2"></i> Memory Management
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <form id="search-memories-form">
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="search-query" placeholder="Search memories...">
                                <button class="btn btn-outline-primary" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <select class="form-select" id="category-filter">
                                        <option value="">All Categories</option>
                                        <option value="general">General</option>
                                        <option value="preference">Preference</option>
                                        <option value="fact">Fact</option>
                                        <option value="instruction">Instruction</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="tags-filter" placeholder="Filter by tags (comma separated)">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMemoryModal">
                            <i class="fas fa-plus me-2"></i> Add New Memory
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div id="memories-list">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Memory Modal -->
<div class="modal fade" id="addMemoryModal" tabindex="-1" aria-labelledby="addMemoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMemoryModalLabel">Add New Memory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-memory-form">
                    <div class="mb-3">
                        <label for="memory-content" class="form-label">Content</label>
                        <textarea class="form-control" id="memory-content" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="memory-category" class="form-label">Category</label>
                        <select class="form-select" id="memory-category">
                            <option value="general">General</option>
                            <option value="preference">Preference</option>
                            <option value="fact">Fact</option>
                            <option value="instruction">Instruction</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="memory-importance" class="form-label">Importance (1-10)</label>
                        <input type="range" class="form-range" min="1" max="10" value="5" id="memory-importance">
                        <div class="d-flex justify-content-between">
                            <small>Low</small>
                            <small id="importance-value">5</small>
                            <small>High</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="memory-tags" class="form-label">Tags (comma separated)</label>
                        <input type="text" class="form-control" id="memory-tags" placeholder="tag1, tag2, tag3">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-memory-btn">Save Memory</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Search form handling
        const searchForm = document.getElementById('search-memories-form');
        const searchQuery = document.getElementById('search-query');
        const categoryFilter = document.getElementById('category-filter');
        const tagsFilter = document.getElementById('tags-filter');
        
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            loadMemories();
        });
        
        // Memory form handling
        const importanceRange = document.getElementById('memory-importance');
        const importanceValue = document.getElementById('importance-value');
        
        importanceRange.addEventListener('input', function() {
            importanceValue.textContent = this.value;
        });
        
        const saveMemoryBtn = document.getElementById('save-memory-btn');
        saveMemoryBtn.addEventListener('click', function() {
            const content = document.getElementById('memory-content').value;
            const category = document.getElementById('memory-category').value;
            const importance = document.getElementById('memory-importance').value;
            const tagsString = document.getElementById('memory-tags').value;
            const tags = tagsString.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            
            if (!content) {
                alert('Memory content is required');
                return;
            }
            
            fetch('/api/memories/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content: content,
                    category: category,
                    importance: parseInt(importance),
                    tags: tags
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'error') {
                    alert('Error: ' + data.message);
                } else {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addMemoryModal'));
                    modal.hide();
                    document.getElementById('add-memory-form').reset();
                    loadMemories();
                }
            })
            .catch(error => {
                console.error('Error adding memory:', error);
                alert('An error occurred while adding the memory');
            });
        });
        
        // Load memories function
        function loadMemories() {
            const container = document.getElementById('memories-list');
            container.innerHTML = `
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            const query = searchQuery.value.trim();
            const category = categoryFilter.value;
            const tagsString = tagsFilter.value.trim();
            const tags = tagsString ? tagsString.split(',').map(tag => tag.trim()) : [];
            
            let url = '/api/memories/search?max_results=50';
            if (query) url += `&query=${encodeURIComponent(query)}`;
            if (category) url += `&category=${encodeURIComponent(category)}`;
            tags.forEach(tag => {
                url += `&tag=${encodeURIComponent(tag)}`;
            });
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.memories && data.memories.length > 0) {
                        let html = '<div class="table-responsive"><table class="table table-hover">';
                        html += `
                            <thead>
                                <tr>
                                    <th>Content</th>
                                    <th>Category</th>
                                    <th>Importance</th>
                                    <th>Tags</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                        `;
                        
                        data.memories.forEach(memory => {
                            const date = new Date(memory.created_at).toLocaleString();
                            const tags = memory.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('');
                            
                            html += `
                                <tr>
                                    <td>${memory.content}</td>
                                    <td><span class="badge bg-info">${memory.category}</span></td>
                                    <td class="text-center">${memory.importance}</td>
                                    <td>${tags}</td>
                                    <td><small>${date}</small></td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table></div>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div class="alert alert-info">No memories found</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading memories:', error);
                    container.innerHTML = '<div class="alert alert-danger">Error loading memories</div>';
                });
        }
        
        // Load memories on page load
        loadMemories();
    });
</script>
{% endblock %}
