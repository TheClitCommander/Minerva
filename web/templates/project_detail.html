{% extends "base.html" %}

{% block title %}Minerva - Project Detail{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Project Information Section -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-project-diagram me-2"></i>
                        <span id="project-title">Project Details</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-light me-2" id="edit-project-btn">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" id="delete-project-btn">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h5 class="text-muted">Description</h5>
                        <p id="project-description">Loading project details...</p>
                    </div>
                    <div class="mb-3">
                        <h5 class="text-muted">Created</h5>
                        <p id="project-created-date">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Project Chat Panel -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-comments me-2"></i>Project Chat
                    </div>
                    <div class="project-chat-controls">
                        <button class="btn btn-sm btn-light" id="project-chat-toggle">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Project Chat Container - Thin by default -->
                <div id="project-chat-container" class="thin-mode">
                    <div id="project-chat-messages" class="project-chat-messages">
                        <!-- Chat messages will appear here -->
                        <div class="project-system-message">
                            <i class="fas fa-robot me-2"></i>This is the project-specific chat. All conversations here will be associated with this project.
                        </div>
                    </div>
                    
                    <div class="project-chat-input-container">
                        <textarea id="project-chat-input" class="project-chat-input" placeholder="Type your message here..."></textarea>
                        <button id="project-chat-send" class="project-chat-send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Conversations Section -->
    <div class="row">
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <i class="fas fa-history me-2"></i>Project Conversations
                </div>
                <div class="card-body">
                    <div id="project-conversations-container">
                        <!-- Conversations will be listed here -->
                        <div class="text-center py-4" id="no-conversations-message">
                            <i class="fas fa-comment-slash fa-3x mb-3 text-muted"></i>
                            <h5 class="text-muted">No conversations in this project yet</h5>
                            <p>Use the project chat above to start new conversations</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Project Modal -->
<div class="modal fade" id="edit-project-modal" tabindex="-1" aria-labelledby="editProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="editProjectModalLabel">Edit Project</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-project-form">
                    <div class="mb-3">
                        <label for="edit-project-name" class="form-label">Project Name</label>
                        <input type="text" class="form-control" id="edit-project-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-project-description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit-project-description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-project-changes">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Project Confirmation Modal -->
<div class="modal fade" id="delete-project-modal" tabindex="-1" aria-labelledby="deleteProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteProjectModalLabel">Delete Project</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this project? This action cannot be undone.</p>
                <p class="fw-bold">All conversations associated with this project will remain in the system but will no longer be associated with this project.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-project">Delete</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let projectId = '';
    let projectData = {};
    let currentConversationId = null;
    let projectChatHistory = [];

    document.addEventListener('DOMContentLoaded', function() {
        // Get project ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        projectId = urlParams.get('id');
        
        if (!projectId) {
            showErrorMessage('No project ID provided');
            return;
        }
        
        // Load project details
        loadProjectDetails();
        
        // Load project conversations
        loadProjectConversations();
        
        // Setup event listeners
        setupEventListeners();
    });
    
    function loadProjectDetails() {
        fetch(`/api/projects/${projectId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load project details');
                }
                return response.json();
            })
            .then(data => {
                projectData = data.project;
                displayProjectDetails(projectData);
                
                // After loading project details, load chat history
                loadProjectChatHistory();
            })
            .catch(error => {
                showErrorMessage('Error loading project details: ' + error.message);
            });
    }
    
    function displayProjectDetails(project) {
        document.getElementById('project-title').textContent = project.name;
        document.getElementById('project-description').textContent = project.description || 'No description provided.';
        
        // Format and display creation date
        const createdDate = new Date(project.created_at);
        document.getElementById('project-created-date').textContent = createdDate.toLocaleString();
        
        // Populate edit form
        document.getElementById('edit-project-name').value = project.name;
        document.getElementById('edit-project-description').value = project.description || '';
    }
    
    function loadProjectConversations() {
        fetch(`/api/projects/${projectId}/conversations`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load project conversations');
                }
                return response.json();
            })
            .then(data => {
                displayProjectConversations(data.conversations);
            })
            .catch(error => {
                showErrorMessage('Error loading project conversations: ' + error.message);
            });
    }
    
    function displayProjectConversations(conversations) {
        const container = document.getElementById('project-conversations-container');
        const noConversationsMessage = document.getElementById('no-conversations-message');
        
        if (!conversations || conversations.length === 0) {
            noConversationsMessage.style.display = 'block';
            return;
        }
        
        noConversationsMessage.style.display = 'none';
        container.innerHTML = '';
        
        conversations.forEach(conversation => {
            const conversationCard = document.createElement('div');
            conversationCard.className = 'conversation-card mb-3 p-3 border rounded';
            
            // Format date
            const conversationDate = new Date(conversation.created_at);
            const formattedDate = conversationDate.toLocaleString();
            
            conversationCard.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5>${conversation.title || 'Untitled Conversation'}</h5>
                        <p class="text-muted small mb-2">Created: ${formattedDate}</p>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary view-conversation-btn" data-id="${conversation.id}">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </div>
                </div>
                <p class="mb-0 conversation-preview">${conversation.preview || 'No preview available'}</p>
            `;
            
            container.appendChild(conversationCard);
        });
        
        // Add event listeners to view buttons
        document.querySelectorAll('.view-conversation-btn').forEach(button => {
            button.addEventListener('click', function() {
                const conversationId = this.getAttribute('data-id');
                window.location.href = `/chat?conversation_id=${conversationId}`;
            });
        });
    }
    
    function setupEventListeners() {
        // Project chat functionality
        const chatInput = document.getElementById('project-chat-input');
        const sendButton = document.getElementById('project-chat-send');
        const messagesContainer = document.getElementById('project-chat-messages');
        
        console.log('Setting up project chat event listeners with elements:', {
            chatInput: !!chatInput,
            sendButton: !!sendButton,
            messagesContainer: !!messagesContainer
        });
        
        // Toggle chat panel size
        document.getElementById('project-chat-toggle').addEventListener('click', function() {
            const chatContainer = document.getElementById('project-chat-container');
            chatContainer.classList.toggle('thin-mode');
            chatContainer.classList.toggle('expanded-mode');
            
            // Update icon
            const icon = this.querySelector('i');
            if (chatContainer.classList.contains('thin-mode')) {
                icon.className = 'fas fa-expand-arrows-alt';
            } else {
                icon.className = 'fas fa-compress-arrows-alt';
            }
            
            // Scroll to bottom of messages
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
        
        // Save chat history to localStorage
        function saveProjectChatHistory() {
            const chatHistoryKey = `minerva_project_chat_${projectId}`;
            const conversationIdKey = `minerva_project_conversation_${projectId}`;
            
            localStorage.setItem(chatHistoryKey, JSON.stringify(projectChatHistory));
            if (currentConversationId) {
                localStorage.setItem(conversationIdKey, currentConversationId);
            }
        }
        
        // Load chat history from localStorage
        function loadProjectChatHistory() {
            try {
                const chatHistoryKey = `minerva_project_chat_${projectId}`;
                const conversationIdKey = `minerva_project_conversation_${projectId}`;
                
                // Restore conversation ID
                const savedConversationId = localStorage.getItem(conversationIdKey);
                if (savedConversationId) {
                    currentConversationId = savedConversationId;
                }
                
                // Restore chat history
                const savedHistory = localStorage.getItem(chatHistoryKey);
                if (savedHistory) {
                    projectChatHistory = JSON.parse(savedHistory);
                    
                    // Clear existing messages
                    const messagesContainer = document.getElementById('project-chat-messages');
                    // Keep only the first message (system message)
                    const systemMessage = messagesContainer.querySelector('.project-system-message');
                    messagesContainer.innerHTML = '';
                    if (systemMessage) {
                        messagesContainer.appendChild(systemMessage);
                    }
                    
                    // Reconstruct chat from history
                    projectChatHistory.forEach(msg => {
                        addMessage(msg.content, msg.sender, msg.modelInfo, false);
                    });
                    
                    // Scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading project chat history:', error);
                projectChatHistory = [];
            }
        }
        
        // Send message function
        function sendMessage() {
            console.log('sendMessage function called');
            const message = chatInput.value.trim();
            if (!message) {
                console.log('No message to send');
                return;
            }
            
            console.log('Sending message:', message);
            
            // Add user message to chat
            addMessage(message, 'user');
            chatInput.value = '';
            
            // Focus back on input for continued conversation
            chatInput.focus();
            
            // Show loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'project-loading-indicator';
            loadingIndicator.innerHTML = 'Minerva is thinking <div class="project-typing-dots"><span>.</span><span>.</span><span>.</span></div>';
            messagesContainer.appendChild(loadingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Send to API with project context
            console.log('Sending to Think Tank API with conversation_id:', currentConversationId, 'project_id:', projectId);
            fetch('/api/think-tank', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    conversation_id: currentConversationId,
                    project_id: projectId,
                    context: {
                        type: 'project',
                        project_name: projectData?.name || 'Untitled Project',
                        project_description: projectData?.description || '',
                        project_id: projectId // Ensuring project_id is included for context-awareness
                    }
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Think Tank API response:', data);
                // Remove loading indicator
                if (messagesContainer.contains(loadingIndicator)) {
                    messagesContainer.removeChild(loadingIndicator);
                }
                
                if (data.response) {
                    // Add AI response
                    addMessage(data.response, 'ai', data.model_info);
                    
                    // Store conversation ID if provided
                    if (data.conversation_id) {
                        console.log('Received conversation_id:', data.conversation_id);
                        currentConversationId = data.conversation_id;
                        
                        // Save conversation ID to localStorage
                        localStorage.setItem(`minerva_project_conversation_${projectId}`, currentConversationId);
                        
                        // If this is a new conversation, refresh the conversations list
                        if (!document.querySelector(`[data-id="${data.conversation_id}"]`)) {
                            loadProjectConversations();
                        }
                    }
                } else {
                    addMessage('Sorry, I encountered an error processing your request.', 'system');
                }
            })
            .catch(error => {
                console.error('API Error:', error);
                
                // Ensure loading indicator is removed even if there was an error
                if (messagesContainer.contains(loadingIndicator)) {
                    messagesContainer.removeChild(loadingIndicator);
                }
                
                // Show user-friendly error message
                addMessage(`I encountered an error processing your request. Please try again.`, 'system');
                
                // Refresh the conversation list to check if the conversation was created despite the error
                setTimeout(() => loadProjectConversations(), 1000);
            });
        }
        
        // Add message to chat
        function addMessage(content, sender, modelInfo = null, saveToHistory = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' ? 'project-user-message' : (sender === 'ai' ? 'project-ai-message' : 'project-system-message');
            messageDiv.textContent = content;
            
            // Add model info if available
            if (modelInfo && sender === 'ai') {
                const modelInfoDiv = document.createElement('div');
                modelInfoDiv.className = 'project-model-info';
                modelInfoDiv.textContent = `Model: ${modelInfo}`;
                messageDiv.appendChild(modelInfoDiv);
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Add to history array and save to localStorage
            if (saveToHistory && sender !== 'system') {
                projectChatHistory.push({
                    content: content,
                    sender: sender,
                    modelInfo: modelInfo,
                    timestamp: new Date().toISOString()
                });
                saveProjectChatHistory();
            }
        }
        
        // Send button click
        if (sendButton) {
            console.log('Attaching click handler to project chat send button');
            sendButton.addEventListener('click', function() {
                console.log('Project chat send button clicked');
                sendMessage();
            });
        } else {
            console.error('Project chat send button not found!');
        }
        
        // Enter key press
        if (chatInput) {
            console.log('Attaching keydown handler to project chat input field');
            
            // Remove any existing event listeners to prevent duplicates
            chatInput.removeEventListener('keydown', handleKeyDown);
            chatInput.removeEventListener('keypress', handleKeyDown);
            
            // Define the keydown handler function separately so we can reference it
            function handleKeyDown(e) {
                console.log('Key pressed in project chat input field:', e.key, 'keyCode:', e.keyCode);
                if ((e.key === 'Enter' || e.keyCode === 13) && !e.shiftKey) {
                    console.log('Enter key pressed in project chat, sending message');
                    e.preventDefault();
                    e.stopPropagation();
                    sendMessage();
                    return false;
                }
                return true;
            }
            
            // Attach both keydown and keypress handlers for better cross-browser support
            chatInput.addEventListener('keydown', handleKeyDown);
            chatInput.addEventListener('keypress', handleKeyDown);
            
            // Also directly inject an onkeydown attribute for maximum compatibility
            chatInput.setAttribute('onkeydown', 'if(event.key === "Enter" && !event.shiftKey) { event.preventDefault(); this.blur(); document.getElementById("project-chat-send").click(); return false; }');
            
            // Focus the input field
            setTimeout(() => chatInput.focus(), 300);
        } else {
            console.error('Project chat input field not found!');
        }
        
        // Edit project button
        document.getElementById('edit-project-btn').addEventListener('click', function() {
            const editModal = new bootstrap.Modal(document.getElementById('edit-project-modal'));
            editModal.show();
        });
        
        // Save project changes
        document.getElementById('save-project-changes').addEventListener('click', function() {
            const name = document.getElementById('edit-project-name').value.trim();
            const description = document.getElementById('edit-project-description').value.trim();
            
            if (!name) {
                alert('Project name is required');
                return;
            }
            
            // Update project via API
            fetch(`/api/projects/${projectId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    description: description
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update project');
                }
                return response.json();
            })
            .then(data => {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('edit-project-modal')).hide();
                
                // Reload project details
                loadProjectDetails();
            })
            .catch(error => {
                alert('Error updating project: ' + error.message);
            });
        });
        
        // Delete project button
        document.getElementById('delete-project-btn').addEventListener('click', function() {
            const deleteModal = new bootstrap.Modal(document.getElementById('delete-project-modal'));
            deleteModal.show();
        });
        
        // Confirm delete project
        document.getElementById('confirm-delete-project').addEventListener('click', function() {
            // Delete project via API
            fetch(`/api/projects/${projectId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete project');
                }
                return response.json();
            })
            .then(data => {
                // Redirect to projects list
                window.location.href = '/projects';
            })
            .catch(error => {
                alert('Error deleting project: ' + error.message);
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('delete-project-modal')).hide();
            });
        });
    }
    
    function showErrorMessage(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger';
        alertDiv.textContent = message;
        
        // Insert at the top of the container
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
    }
</script>
{% endblock %}
