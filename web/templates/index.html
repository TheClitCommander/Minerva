{% extends "base.html" %}

{% block title %}Minerva - Intelligent Conversation Assistant{% endblock %}

{% block content %}
<!-- Minerva Orb Button -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
    <button id="minerva-orb" class="btn btn-primary rounded-circle shadow" style="width: 60px; height: 60px;">
        <i class="fas fa-brain fa-lg"></i>
    </button>
</div>

<!-- Floating Chat Interface -->
<div id="minerva-floating-chat" class="minerva-floating-chat" style="display: none; width: 400px; height: 500px; right: 20px; bottom: 90px; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1040;">
    <div class="minerva-chat-header" style="background: linear-gradient(135deg, #7952b3, #6f42c1); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;">
        <div class="minerva-chat-title">
            <i class="fas fa-brain me-2"></i>Minerva Think Tank
        </div>
        <div class="minerva-chat-controls">
            <button class="minerva-chat-button" id="minerva-minimize-btn" title="Minimize" style="background: transparent; border: none; color: white; margin-right: 8px;">
                <i class="fas fa-minus"></i>
            </button>
            <button class="minerva-chat-button" id="minerva-close-btn" title="Close" style="background: transparent; border: none; color: white;">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- Debug information (visible during testing) -->
    <div id="debug-output" style="display: block; position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.85); color: #00ff00; font-family: monospace; font-size: 11px; padding: 4px 8px; z-index: 1050; max-height: 100px; overflow-y: auto;"><strong>Debug Info:</strong> Initializing Minerva Direct Connector...</div>
    
    <div class="minerva-chat-messages" id="minerva-chat-messages" style="height: calc(100% - 110px); overflow-y: auto; padding: 15px; background-color: #f8f9fa;">
        <!-- Chat messages will appear here -->
        <div class="minerva-system-message" style="background-color: #e9ecef; color: #495057; padding: 10px; border-radius: 10px; margin-bottom: 10px; max-width: 80%; font-size: 0.9rem;">
            <i class="fas fa-robot me-2"></i>Welcome to Minerva. How can I assist you today?
        </div>
    </div>
    
    <div class="minerva-chat-input-container" style="display: flex; padding: 10px; background-color: white; border-top: 1px solid #dee2e6;">
        <textarea class="minerva-chat-input" id="minerva-chat-input" placeholder="Type your message here..." style="flex: 1; border: 1px solid #ced4da; border-radius: 20px; padding: 10px; resize: none; outline: none;"></textarea>
        <button class="minerva-send-btn" id="minerva-send-btn" style="background-color: #7952b3; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 10px; cursor: pointer;">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>

<!-- Project Organization -->
<div class="card mb-4">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <div><i class="fas fa-project-diagram me-2"></i>Projects and Conversations</div>
        <div>
            <button class="btn btn-sm btn-outline-light" id="create-project-btn">
                <i class="fas fa-plus"></i> New Project
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="row" id="projects-container">
            <!-- Project squares will go here -->
            {% for i in range(1, 4) %}
            <div class="col-md-4 mb-3">
                <div class="project-card" data-project-id="{{ i }}">
                    <div class="project-header d-flex justify-content-between">
                        <h5>Project {{ i }}</h5>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#">Rename</a></li>
                                <li><a class="dropdown-item" href="#">Archive</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#">Delete</a></li>
                            </ul>
                        </div>
                    </div>
                    <p class="project-description">Sample project with {{ i*2 }} conversations</p>
                    <div class="project-branches" id="project-{{ i }}-branches">
                        <div class="branch-node">Main Thread</div>
                        <div class="branch-node">Branch 1</div>
                        <div class="branch-node">Branch 2</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- 3D Orbital Interface for Minerva -->
<div class="card mb-4">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <div><i class="fas fa-atom me-2"></i>Minerva Orbital Interface</div>
        <div>
            <button class="btn btn-sm btn-outline-light" id="toggle-orbital-view-btn">
                <i class="fas fa-expand-alt"></i> Toggle Full View
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div id="minerva-orbital-ui" class="orbital-ui-container" style="height: 400px; width: 100%;"></div>
    </div>
</div>

<!-- Model Performance at a Glance -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <i class="fas fa-chart-line me-2"></i>Think Tank Performance
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="stats-card h-100" style="background-color: #7952b3; color: white;">
                    <div><i class="fas fa-balance-scale fa-2x"></i></div>
                    <div class="stats-value" id="blending-percentage">87.5%</div>
                    <div>Optimal Blending</div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stats-card h-100" style="background-color: #20c997; color: white;">
                    <div><i class="fas fa-tachometer-alt fa-2x"></i></div>
                    <div class="stats-value" id="rank-accuracy">92.3%</div>
                    <div>Ranking Accuracy</div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stats-card h-100" style="background-color: #fd7e14; color: white;">
                    <div><i class="fas fa-tasks fa-2x"></i></div>
                    <div class="stats-value" id="routing-efficiency">95.1%</div>
                    <div>Routing Efficiency</div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-end">
        <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-primary">View Detailed Analytics</a>
    </div>
</div>
</div>

<!-- Add Memory Modal -->
<div class="modal fade" id="addMemoryModal" tabindex="-1" aria-labelledby="addMemoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMemoryModalLabel">Add New Memory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-memory-form">
                    <div class="mb-3">
                        <label for="memory-content" class="form-label">Content</label>
                        <textarea class="form-control" id="memory-content" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="memory-category" class="form-label">Category</label>
                        <select class="form-select" id="memory-category">
                            <option value="general">General</option>
                            <option value="preference">Preference</option>
                            <option value="fact">Fact</option>
                            <option value="instruction">Instruction</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="memory-importance" class="form-label">Importance (1-10)</label>
                        <input type="range" class="form-range" min="1" max="10" value="5" id="memory-importance">
                        <div class="d-flex justify-content-between">
                            <small>Low</small>
                            <small id="importance-value">5</small>
                            <small>High</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="memory-tags" class="form-label">Tags (comma separated)</label>
                        <input type="text" class="form-control" id="memory-tags" placeholder="tag1, tag2, tag3">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-memory-btn">Save Memory</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load 3D UI scripts -->
<script src="{{ url_for('static', filename='js/orb-ui/minerva-3d-loader.js') }}"></script>
<script src="{{ url_for('static', filename='js/think-tank-bridge.js') }}"></script>

<!-- Load chat integration -->
<script src="{{ url_for('static', filename='js/chat-integration.js') }}"></script>

<script>
    // Load the direct connector script
    function loadScript(url, callback) {
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = url;
        script.onload = callback;
        document.head.appendChild(script);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Load the direct connector first
        loadScript('/static/js/minerva-direct-connector.js', function() {
            // Then initialize the chat
            initMinervaDirect();
            // Also initialize the floating chat as a backup
            initFloatingChat();
        });
        
        // Update importance value display
        const importanceRange = document.getElementById('memory-importance');
        const importanceValue = document.getElementById('importance-value');
        
        if (importanceRange && importanceValue) {
            importanceRange.addEventListener('input', function() {
                importanceValue.textContent = this.value;
            });
        }
        
        // Handle memory form submission
        const saveMemoryBtn = document.getElementById('save-memory-btn');
        if (saveMemoryBtn) {
            saveMemoryBtn.addEventListener('click', function() {
                const content = document.getElementById('memory-content').value;
                const category = document.getElementById('memory-category').value;
                const importance = document.getElementById('memory-importance').value;
                const tagsString = document.getElementById('memory-tags').value;
                const tags = tagsString.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
                
                if (!content) {
                    alert('Memory content is required');
                    return;
                }
                
                // Send API request to add memory
                fetch('/api/memories/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        category: category,
                        importance: parseInt(importance),
                        tags: tags
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        alert('Error: ' + data.message);
                    } else {
                        // Close modal and reset form
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addMemoryModal'));
                        modal.hide();
                        document.getElementById('add-memory-form').reset();
                        
                        // Reload recent memories
                        loadRecentMemories();
                    }
                })
                .catch(error => {
                    console.error('Error adding memory:', error);
                    alert('An error occurred while adding the memory');
                });
            });
        }
        
        // Load recent memories
        function loadRecentMemories() {
            const container = document.getElementById('recent-memories-container');
            
            fetch('/api/memories/search?max_results=5')
                .then(response => response.json())
                .then(data => {
                    if (data.memories && data.memories.length > 0) {
                        let html = '<div class="list-group">';
                        
                        data.memories.forEach(memory => {
                            const date = new Date(memory.created_at).toLocaleString();
                            const tags = memory.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('');
                            
                            html += `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${memory.category}</h6>
                                    <small class="text-muted">Importance: ${memory.importance}</small>
                                </div>
                                <p class="mb-1">${memory.content}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small>${tags}</small>
                                    <small class="text-muted">${date}</small>
                                </div>
                            </div>
                            `;
                        });
                        
                        html += '</div>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div class="alert alert-info">No memories found</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading memories:', error);
                    container.innerHTML = '<div class="alert alert-danger">Error loading memories</div>';
                });
        }
        
        // Load memories on page load
        loadRecentMemories();
        
    });
    
    // Initialize direct Minerva connector
    function initMinervaDirect() {
        const debugOutput = document.getElementById('debug-output');
        const chatMessages = document.getElementById('minerva-chat-messages');
        const chatInput = document.getElementById('minerva-chat-input');
        const sendButton = document.getElementById('minerva-send-btn');
        
        if (!debugOutput || !chatMessages || !chatInput || !sendButton) {
            console.error('Missing required chat elements');
            return;
        }
        
        debugOutput.innerHTML = '<strong>Debug Info:</strong> Initializing Minerva Direct Connector...';
        
        // Create connector
        const connector = new MinervaDirectConnector({
            debug: true
        });
        
        // Add message to chat
        function addMessage(text, sender, modelInfo) {
            const messageDiv = document.createElement('div');
            
            if (sender === 'user') {
                messageDiv.className = 'minerva-user-message';
                messageDiv.innerHTML = `<div style="background-color: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 10px; margin-bottom: 10px; margin-left: auto; max-width: 80%; text-align: right;">${text}</div>`;
            } else if (sender === 'ai') {
                messageDiv.className = 'minerva-ai-message';
                messageDiv.innerHTML = `<div style="background-color: #f1f3f4; color: #202124; padding: 10px; border-radius: 10px; margin-bottom: 10px; max-width: 80%;">${text}</div>`;
                
                // Add model info if available
                if (modelInfo) {
                    const modelText = typeof modelInfo === 'string' ? modelInfo : 
                        (modelInfo.primary_model || 'Think Tank');
                    
                    const modelDiv = document.createElement('div');
                    modelDiv.style.fontSize = '0.8rem';
                    modelDiv.style.color = '#5f6368';
                    modelDiv.style.marginTop = '4px';
                    modelDiv.style.marginBottom = '10px';
                    modelDiv.innerHTML = `<i class="fas fa-robot"></i> ${modelText}`;
                    messageDiv.appendChild(modelDiv);
                }
            } else {
                // System message
                messageDiv.className = 'minerva-system-message';
                messageDiv.innerHTML = `<div style="background-color: #e9ecef; color: #495057; padding: 10px; border-radius: 10px; margin-bottom: 10px; max-width: 80%; font-size: 0.9rem;"><i class="fas fa-robot me-2"></i>${text}</div>`;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Handle sending messages
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Add user message
            addMessage(message, 'user');
            
            // Clear input
            chatInput.value = '';
            
            // Show loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.innerHTML = '<div style="background-color: #f1f3f4; color: #202124; padding: 10px; border-radius: 10px; margin-bottom: 10px; max-width: 80%;"><i class="fas fa-spinner fa-spin"></i> Processing...</div>';
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Send to connector
            connector.sendMessage(
                message,
                // Success handler
                (response) => {
                    // Remove loading indicator
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        chatMessages.removeChild(loadingIndicator);
                    }
                    
                    // Add AI response
                    addMessage(response.text, 'ai', response.modelInfo);
                    
                    // Debug
                    debugOutput.innerHTML += '<br>Response received successfully';
                },
                // Error handler
                (error) => {
                    // Remove loading indicator
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        chatMessages.removeChild(loadingIndicator);
                    }
                    
                    if (error.offline) {
                        addMessage("I'm having trouble connecting to the server. Your message was saved locally.", 'system');
                    } else {
                        addMessage("Sorry, there was an error processing your request.", 'system');
                    }
                    
                    // Debug
                    debugOutput.innerHTML += '<br>Error: ' + (error.error || 'Unknown error');
                }
            );
        }
        
        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
                e.preventDefault();
            }
        });
        
        // Check for offline messages
        const offlineMessages = connector.getOfflineMessages();
        if (offlineMessages && offlineMessages.length > 0) {
            debugOutput.innerHTML += `<br>Found ${offlineMessages.length} offline messages`;
            setTimeout(() => {
                if (confirm(`You have ${offlineMessages.length} unsent message(s). Would you like to try sending them now?`)) {
                    offlineMessages.forEach(msg => {
                        chatInput.value = msg.message;
                        sendMessage();
                    });
                    connector.clearOfflineMessages();
                }
            }, 1000);
        }
        
        // Update debug output
        debugOutput.innerHTML += '<br>Direct connector initialized successfully';
    }
    
    // Initialize Floating Chat functionality
    function initFloatingChat() {
            const floatingChat = document.getElementById('minerva-floating-chat');
            const orb = document.getElementById('minerva-orb');
            const closeBtn = document.getElementById('minerva-close-btn');
            const minimizeBtn = document.getElementById('minerva-minimize-btn');
            const inputField = document.getElementById('minerva-chat-input');
            const sendBtn = document.getElementById('minerva-send-btn');
            const messagesContainer = document.getElementById('minerva-chat-messages');
            
            console.log('Initializing Floating Chat with elements:', {
                floatingChat: !!floatingChat,
                orb: !!orb,
                closeBtn: !!closeBtn,
                minimizeBtn: !!minimizeBtn,
                inputField: !!inputField,
                sendBtn: !!sendBtn,
                messagesContainer: !!messagesContainer
            });
            
            // Toggle chat visibility when Minerva Orb is clicked
            orb.addEventListener('click', () => {
                floatingChat.style.display = 'flex';
                inputField.focus();
                
                // Load chat history from localStorage if available
                loadChatHistoryFromStorage();
            });
            
            // Close chat when close button is clicked
            closeBtn.addEventListener('click', () => {
                floatingChat.style.display = 'none';
            });
            
            // Minimize chat when minimize button is clicked
            minimizeBtn.addEventListener('click', () => {
                floatingChat.style.display = 'none';
            });
            
            // Save chat history to localStorage
            function saveChatHistoryToStorage() {
                localStorage.setItem('minerva_chat_history', JSON.stringify(chatHistory));
                if (currentConversationId) {
                    localStorage.setItem('minerva_conversation_id', currentConversationId);
                }
            }
            
            // Load chat history from localStorage
            function loadChatHistoryFromStorage() {
                try {
                    const savedHistory = localStorage.getItem('minerva_chat_history');
                    if (savedHistory) {
                        chatHistory = JSON.parse(savedHistory);
                        
                        // Clear existing messages
                        messagesContainer.innerHTML = '';
                        
                        // Reconstruct chat from history
                        chatHistory.forEach(msg => {
                            addMessage(msg.content, msg.sender, msg.modelInfo, false);
                        });
                        
                        // Scroll to bottom
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                } catch (error) {
                    console.error('Error loading chat history:', error);
                    // Reset history if there's an error
                    chatHistory = [];
                }
            }
            
            // Function to send messages
            function sendMessage() {
                const message = inputField.value.trim();
                if (message) {
                    // Add user message to chat
                    addMessage(message, 'user');
                    inputField.value = '';
                    
                    // Show typing indicator
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.className = 'minerva-loading-indicator';
                    loadingIndicator.innerHTML = 'Minerva is thinking <div class="minerva-typing-dots"><span>.</span><span>.</span><span>.</span></div>';
                    messagesContainer.appendChild(loadingIndicator);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // Send message to Think Tank API
                    fetch('/api/think-tank', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            conversation_id: currentConversationId || null
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Log full API response for debugging
                        console.log('Think Tank API response:', JSON.stringify(data));
                        
                        // Remove loading indicator
                        if (loadingIndicator && loadingIndicator.parentNode === messagesContainer) {
                            messagesContainer.removeChild(loadingIndicator);
                        }
                        
                        try {
                            // Extract the response based on available structure
                            let responseText = '';
                            let modelName = null;
                            
                            // Display raw response data in debug output
                            const debugOutput = document.getElementById('debug-output');
                            debugOutput.style.display = 'block';
                            debugOutput.textContent = 'API Response received';
                            
                            // Force the browser to re-parse the JSON if it's a string
                            let parsedData = data;
                            if (typeof data === 'string') {
                                try {
                                    parsedData = JSON.parse(data);
                                    console.log('Parsed string data into object:', parsedData);
                                } catch (e) {
                                    console.log('Data is a string but not valid JSON, using as-is');
                                }
                            }
                            
                            // Always work with parsedData from now on
                            data = parsedData;
                            
                            // Log the detailed structure for debugging
                            console.log('Response structure:', JSON.stringify(data, null, 2));
                            console.log('Response keys:', Object.keys(data));
                            
                            // Show the structured response for debugging
                            debugOutput.textContent = 'API Response keys: ' + Object.keys(data).join(', ');
                            
                            // PRIORITY 1: Extract from responses object (Think Tank format)
                            if (data.responses && typeof data.responses === 'object') {
                                console.log('Found responses object:', data.responses);
                                const modelNames = Object.keys(data.responses);
                                console.log('Available models:', modelNames);
                                debugOutput.textContent += ' | Models: ' + modelNames.join(', ');
                                
                                if (modelNames.length > 0) {
                                    modelName = modelNames[0];
                                    responseText = data.responses[modelName];
                                    console.log(`Using model ${modelName} response:`, responseText);
                                    debugOutput.textContent += ` | Using ${modelName}`;
                                }
                            }
                            // PRIORITY 2: Direct response field (simple API format)
                            else if (data.response && typeof data.response === 'string') {
                                console.log('Found direct response field');
                                responseText = data.response;
                                debugOutput.textContent += ' | Using direct response';
                            }
                            // PRIORITY 3: Message field (alternate format)
                            else if (data.message && typeof data.message === 'string') {
                                console.log('Found message field');
                                responseText = data.message;
                                debugOutput.textContent += ' | Using message field';
                            }
                            // PRIORITY 4: Entire string response
                            else if (typeof data === 'string') {
                                console.log('Using entire string as response');
                                responseText = data;
                                debugOutput.textContent += ' | Using string data';
                            }
                            // PRIORITY 5: Last resort - try to extract any text content
                            else {
                                console.log('No standard response format found, attempting fallbacks');
                                debugOutput.textContent += ' | Using fallback extraction';
                                if (data.text) responseText = data.text;
                                else if (data.content) responseText = data.content;
                                else if (data.result) responseText = data.result;
                                else console.error('No recognizable response format found');
                            }
                            
                            // Final debug output with found response text
                            if (responseText) {
                                const truncated = responseText.substring(0, 30) + (responseText.length > 30 ? '...' : '');
                                debugOutput.textContent += ' | Text: ' + truncated;
                            } else {
                                debugOutput.textContent += ' | NO TEXT FOUND';
                            }
                            
                            // Ensure we have a valid response text
                            if (responseText && typeof responseText === 'string') {
                                console.log('Final response text:', responseText);
                                // Add AI response to chat
                                addMessage(responseText, 'ai', modelName);
                                
                                // Store conversation ID if returned
                                if (data.conversation_id) {
                                    currentConversationId = data.conversation_id;
                                    localStorage.setItem('minerva_conversation_id', currentConversationId);
                                    console.log('Stored conversation ID:', currentConversationId);
                                }
                            } else {
                                console.error('No valid response text extracted from:', data);
                                addMessage('Sorry, I encountered an error processing your request. No valid response found.', 'system');
                            }
                        } catch (error) {
                            console.error('Error processing Think Tank response:', error);
                            addMessage('Sorry, I encountered an error processing the response.', 'system');
                        }
                    })
                    .catch(error => {
                        // Remove loading indicator
                        messagesContainer.removeChild(loadingIndicator);
                        addMessage('Network error. Please try again later.', 'system');
                        console.error('Error:', error);
                    });
                }
            }
            
            // Add message to chat
            function addMessage(content, sender, modelInfo = null, saveToHistory = true) {
                console.log(`Adding message - Content: "${content}", Sender: ${sender}, Model: ${modelInfo}`);
                document.getElementById('debug-output').textContent = `Last message: ${sender} - ${content}`;
                
                // Create message element with specific styling
                const messageDiv = document.createElement('div');
                
                // Apply appropriate classes and styles based on sender
                if (sender === 'user') {
                    messageDiv.className = 'minerva-user-message';
                    messageDiv.style.cssText = 'background-color: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 10px; margin: 5px 0 5px auto; max-width: 80%; font-size: 0.95rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);';
                } else if (sender === 'ai') {
                    messageDiv.className = 'minerva-ai-message';
                    messageDiv.style.cssText = 'background-color: #f0f4ff; color: #333; padding: 10px; border-radius: 10px; margin: 5px auto 5px 0; max-width: 80%; font-size: 0.95rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);';
                } else {
                    messageDiv.className = 'minerva-system-message';
                    messageDiv.style.cssText = 'background-color: #e9ecef; color: #495057; padding: 10px; border-radius: 10px; margin: 5px auto; max-width: 80%; font-size: 0.9rem; text-align: center;';
                }
                
                // Create message content element
                const contentElement = document.createElement('div');
                contentElement.className = 'message-content';
                
                // Use innerHTML for AI messages to support formatted text
                if (sender === 'ai') {
                    // Use innerHTML for AI responses but sanitize it first
                    const sanitizedContent = content
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/\n/g, '<br>');
                    contentElement.innerHTML = sanitizedContent;
                } else {
                    // For user messages, use textContent for security
                    contentElement.textContent = content;
                }
                
                // Add content to message div
                messageDiv.appendChild(contentElement);
                
                // Add model info if available
                if (modelInfo && sender === 'ai') {
                    const modelInfoDiv = document.createElement('div');
                    modelInfoDiv.className = 'minerva-model-info';
                    modelInfoDiv.style.cssText = 'font-size: 0.75rem; color: #6c757d; margin-top: 5px; font-style: italic;';
                    modelInfoDiv.textContent = `Model: ${modelInfo}`;
                    messageDiv.appendChild(modelInfoDiv);
                }
                
                console.log('Appending message to container');
                
                // Debug: Count messages in container before adding
                console.log(`Messages container has ${messagesContainer.children.length} messages before adding new one`);
                
                // Add the message to the container
                messagesContainer.appendChild(messageDiv);
                
                // Force reflow to ensure the message is properly rendered
                void messageDiv.offsetWidth;
                
                // Scroll to the bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                console.log('Message added to UI');
                
                // Add to history array and save to localStorage
                if (saveToHistory && sender !== 'system') {
                    chatHistory.push({
                        content: content,
                        sender: sender,
                        modelInfo: modelInfo,
                        timestamp: new Date().toISOString()
                    });
                    saveChatHistoryToStorage();
                }
                
                return messageDiv; // Return the created element for testing
            }
            
            // Send message when send button is clicked
            if (sendBtn) {
                console.log('Attaching click handler to send button');
                sendBtn.addEventListener('click', function() {
                    console.log('Send button clicked');
                    sendMessage();
                });
            } else {
                console.error('Send button not found!');
            }
            
            // Send message when Enter key is pressed (without Shift)
            if (inputField) {
                console.log('Attaching keydown handler to input field');
                // Remove any existing event listeners
                inputField.removeEventListener('keydown', handleKeyDown);
                
                // Define the keydown handler function separately so we can reference it
                function handleKeyDown(e) {
                    console.log('Key pressed in input field:', e.key, 'keyCode:', e.keyCode);
                    if ((e.key === 'Enter' || e.keyCode === 13) && !e.shiftKey) {
                        console.log('Enter key pressed, sending message');
                        e.preventDefault();
                        e.stopPropagation();
                        sendMessage();
                        return false;
                    }
                    return true;
                }
                
                // Attach the handler using both keydown and keypress for better cross-browser support
                inputField.addEventListener('keydown', handleKeyDown);
                inputField.addEventListener('keypress', handleKeyDown);
                
                // Also directly inject an onkeydown attribute for maximum compatibility
                inputField.setAttribute('onkeydown', 'if(event.key === "Enter" && !event.shiftKey) { event.preventDefault(); this.blur(); document.getElementById("minerva-send-btn").click(); return false; }');
                
                // Focus the input field when the chat is opened
                setTimeout(() => inputField.focus(), 300);
            } else {
                console.error('Input field not found!');
            }
            
            // Make chat draggable
            let isDragging = false;
            let offsetX, offsetY;
            
            const header = floatingChat.querySelector('.minerva-chat-header');
            
            header.addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - floatingChat.getBoundingClientRect().left;
                offsetY = e.clientY - floatingChat.getBoundingClientRect().top;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const x = e.clientX - offsetX;
                    const y = e.clientY - offsetY;
                    
                    // Ensure chat stays within viewport
                    const maxX = window.innerWidth - floatingChat.offsetWidth;
                    const maxY = window.innerHeight - floatingChat.offsetHeight;
                    
                    const newX = Math.max(0, Math.min(x, maxX));
                    const newY = Math.max(0, Math.min(y, maxY));
                    
                    floatingChat.style.left = newX + 'px';
                    floatingChat.style.right = 'auto';
                    floatingChat.style.top = newY + 'px';
                    floatingChat.style.bottom = 'auto';
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            // Initialize conversation data
            let currentConversationId = localStorage.getItem('minerva_conversation_id') || null;
            let chatHistory = [];
        }
</script>
{% endblock %}
