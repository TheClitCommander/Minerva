{% extends "base.html" %}

{% block title %}Enhanced Analytics - Minerva{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">
        <i class="fas fa-chart-line me-2"></i> Enhanced API Analytics
    </h1>
    
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle me-2"></i> This page provides separate analytics for real and simulated API calls, helping you monitor actual API usage accurately.
    </div>
    
    <!-- Toggle Buttons for Real vs Simulated -->
    <div class="btn-group mb-4" role="group">
        <button type="button" class="btn btn-primary active" id="real-api-btn">Real API Calls</button>
        <button type="button" class="btn btn-secondary" id="simulated-api-btn">Simulated Calls</button>
        <button type="button" class="btn btn-info" id="combined-view-btn">Combined View</button>
    </div>

    <!-- Summary Statistics Cards -->
    <div class="row mb-4" id="real-stats">
        <div class="col-md-12 mb-3">
            <h3>Real API Usage <small class="text-muted">(Actual External API Calls)</small></h3>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card h-100 border-primary">
                <div class="card-body text-center">
                    <h5 class="card-title text-primary">API Calls</h5>
                    <h2 class="display-4">{{ summary_metrics.real_total_calls }}</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card h-100 border-success">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">Tokens</h5>
                    <h2 class="display-4">{{ summary_metrics.real_total_tokens }}</h2>
                    <p class="card-text text-muted">Actual usage</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card h-100 border-danger">
                <div class="card-body text-center">
                    <h5 class="card-title text-danger">Cost</h5>
                    <h2 class="display-4">${{ summary_metrics.real_total_cost }}</h2>
                    <p class="card-text text-muted">Estimated USD</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card h-100 border-info">
                <div class="card-body text-center">
                    <h5 class="card-title text-info">Avg Time</h5>
                    <h2 class="display-4">{{ summary_metrics.avg_response_time }}s</h2>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4" id="simulated-stats" style="display:none;">
        <div class="col-md-12 mb-3">
            <h3>Simulated API Usage <small class="text-muted">(Internal Responses)</small></h3>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100 border-secondary">
                <div class="card-body text-center">
                    <h5 class="card-title text-secondary">Simulated Calls</h5>
                    <h2 class="display-4">{{ summary_metrics.sim_total_calls }}</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-3">
            <div class="card h-100 border-secondary">
                <div class="card-body text-center">
                    <h5 class="card-title text-secondary">Simulated Tokens</h5>
                    <h2 class="display-4">{{ summary_metrics.sim_total_tokens }}</h2>
                    <p class="card-text text-muted">No cost (internal simulation)</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-3">
            <div class="card h-100 border-secondary">
                <div class="card-body text-center">
                    <h5 class="card-title text-secondary">Savings</h5>
                    <h2 class="display-4">100%</h2>
                    <p class="card-text text-muted">Costs avoided through simulation</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- API Usage Charts -->
    <div class="row mb-4" id="real-usage-chart">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Real API Usage by Model</h5>
                </div>
                <div class="card-body">
                    <canvas id="realModelUsageChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4" id="simulated-usage-chart" style="display:none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Simulated API Usage by Model</h5>
                </div>
                <div class="card-body">
                    <canvas id="simModelUsageChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4" id="combined-usage-chart" style="display:none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Combined API Usage Comparison</h5>
                </div>
                <div class="card-body">
                    <canvas id="combinedUsageChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Model Usage Tables -->
    <div class="row mb-4" id="real-models-table">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Real API Call Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Model</th>
                                    <th class="text-center">Call Count</th>
                                    <th class="text-center">Total Tokens</th>
                                    <th class="text-center">Avg Response Time</th>
                                    <th class="text-center">Estimated Cost</th>
                                    <th class="text-center">Last Used</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for model in real_models %}
                                <tr>
                                    <td><strong>{{ model.model }}</strong></td>
                                    <td class="text-center">{{ model.count }}</td>
                                    <td class="text-center">{{ model.tokens }}</td>
                                    <td class="text-center">{{ model.avg_time }}s</td>
                                    <td class="text-center">${{ model.estimated_cost }}</td>
                                    <td class="text-center">{{ model.last_used }}</td>
                                </tr>
                                {% endfor %}
                                {% if not real_models %}
                                <tr>
                                    <td colspan="6" class="text-center">No real API calls recorded yet</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4" id="simulated-models-table" style="display:none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Simulated API Call Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead class="table-secondary">
                                <tr>
                                    <th>Model</th>
                                    <th class="text-center">Call Count</th>
                                    <th class="text-center">Total Tokens</th>
                                    <th class="text-center">Avg Response Time</th>
                                    <th class="text-center">Last Used</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for model in simulated_models %}
                                <tr>
                                    <td><strong>{{ model.model }}</strong></td>
                                    <td class="text-center">{{ model.count }}</td>
                                    <td class="text-center">{{ model.tokens }}</td>
                                    <td class="text-center">{{ model.avg_time }}s</td>
                                    <td class="text-center">{{ model.last_used }}</td>
                                </tr>
                                {% endfor %}
                                {% if not simulated_models %}
                                <tr>
                                    <td colspan="5" class="text-center">No simulated API calls recorded yet</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// This avoids the Jinja template mixing issue by receiving a complete JSON object
const chartData = {{ chart_data_json|safe }};

document.addEventListener('DOMContentLoaded', function() {
    // Helper function to set up charts
    function setupCharts() {
        // Real Model Usage Chart
        if (chartData.realLabels && chartData.realLabels.length > 0) {
            const realChartCtx = document.getElementById('realModelUsageChart').getContext('2d');
            new Chart(realChartCtx, {
                type: 'bar',
                data: {
                    labels: chartData.realLabels,
                    datasets: [{
                        label: 'API Calls',
                        data: chartData.realCallCounts,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Number of Real API Calls by Model'
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        // Simulated Model Usage Chart
        if (chartData.simLabels && chartData.simLabels.length > 0) {
            const simChartCtx = document.getElementById('simModelUsageChart').getContext('2d');
            new Chart(simChartCtx, {
                type: 'bar',
                data: {
                    labels: chartData.simLabels,
                    datasets: [{
                        label: 'Simulated Calls',
                        data: chartData.simCallCounts,
                        backgroundColor: 'rgba(153, 102, 255, 0.7)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Number of Simulated API Calls by Model'
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        // Combined Usage Chart
        const combinedChartCtx = document.getElementById('combinedUsageChart').getContext('2d');
        new Chart(combinedChartCtx, {
            type: 'bar',
            data: {
                labels: ['Real API Calls', 'Simulated Calls'],
                datasets: [{
                    label: 'Call Count',
                    data: [chartData.totalRealCalls, chartData.totalSimCalls],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Real vs Simulated API Call Comparison'
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
    
    // Tab switching functionality
    document.getElementById('real-api-btn').addEventListener('click', function() {
        // Show real API stats and hide others
        document.getElementById('real-stats').style.display = 'flex';
        document.getElementById('simulated-stats').style.display = 'none';
        document.getElementById('real-usage-chart').style.display = 'flex';
        document.getElementById('simulated-usage-chart').style.display = 'none';
        document.getElementById('combined-usage-chart').style.display = 'none';
        document.getElementById('real-models-table').style.display = 'flex';
        document.getElementById('simulated-models-table').style.display = 'none';
        
        // Update button states
        this.classList.add('active');
        this.classList.remove('btn-secondary');
        this.classList.add('btn-primary');
        document.getElementById('simulated-api-btn').classList.remove('active');
        document.getElementById('simulated-api-btn').classList.remove('btn-primary');
        document.getElementById('simulated-api-btn').classList.add('btn-secondary');
        document.getElementById('combined-view-btn').classList.remove('active');
        document.getElementById('combined-view-btn').classList.add('btn-secondary');
        document.getElementById('combined-view-btn').classList.remove('btn-info');
    });
    
    document.getElementById('simulated-api-btn').addEventListener('click', function() {
        // Show simulated API stats and hide others
        document.getElementById('real-stats').style.display = 'none';
        document.getElementById('simulated-stats').style.display = 'flex';
        document.getElementById('real-usage-chart').style.display = 'none';
        document.getElementById('simulated-usage-chart').style.display = 'flex';
        document.getElementById('combined-usage-chart').style.display = 'none';
        document.getElementById('real-models-table').style.display = 'none';
        document.getElementById('simulated-models-table').style.display = 'flex';
        
        // Update button states
        this.classList.add('active');
        this.classList.remove('btn-secondary');
        this.classList.add('btn-primary');
        document.getElementById('real-api-btn').classList.remove('active');
        document.getElementById('real-api-btn').classList.remove('btn-primary');
        document.getElementById('real-api-btn').classList.add('btn-secondary');
        document.getElementById('combined-view-btn').classList.remove('active');
        document.getElementById('combined-view-btn').classList.add('btn-secondary');
        document.getElementById('combined-view-btn').classList.remove('btn-info');
    });
    
    document.getElementById('combined-view-btn').addEventListener('click', function() {
        // Show combined view and both tables
        document.getElementById('real-stats').style.display = 'flex';
        document.getElementById('simulated-stats').style.display = 'flex';
        document.getElementById('real-usage-chart').style.display = 'none';
        document.getElementById('simulated-usage-chart').style.display = 'none';
        document.getElementById('combined-usage-chart').style.display = 'flex';
        document.getElementById('real-models-table').style.display = 'flex';
        document.getElementById('simulated-models-table').style.display = 'flex';
        
        // Update button states
        this.classList.add('active');
        this.classList.add('btn-info');
        this.classList.remove('btn-secondary');
        document.getElementById('real-api-btn').classList.remove('active');
        document.getElementById('real-api-btn').classList.remove('btn-primary');
        document.getElementById('real-api-btn').classList.add('btn-secondary');
        document.getElementById('simulated-api-btn').classList.remove('active');
        document.getElementById('simulated-api-btn').classList.remove('btn-primary');
        document.getElementById('simulated-api-btn').classList.add('btn-secondary');
    });
    
    // Initialize charts
    setupCharts();
});
</script>
{% endblock %}
