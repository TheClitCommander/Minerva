<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minerva - Milky Way</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            background-color: #000;
            font-family: Arial, sans-serif;
        }
        
        #space-container {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, 
                rgba(50, 50, 120, 0.3) 0%, 
                rgba(20, 20, 60, 0.2) 40%, 
                rgba(5, 5, 30, 0.1) 70%, 
                rgba(0, 0, 10, 0) 100%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400"><rect width="400" height="400" fill="black"/><g fill="white">%STARS%</g></svg>');
            overflow: hidden;
        }
        
        #minerva-orb {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, 
                white 0%, 
                #ADD8E6 20%, 
                #4a7ee7 60%, 
                #1E3E7B 100%);
            box-shadow: 0 0 50px 20px rgba(74, 126, 231, 0.5),
                       0 0 100px 40px rgba(74, 126, 231, 0.3);
            animation: pulse 4s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 4s infinite;
        }
        
        @keyframes twinkle {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }
        
        .galaxy-arm {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center;
            background: radial-gradient(ellipse at center, 
                rgba(100, 149, 237, 0.1) 0%, 
                rgba(100, 149, 237, 0) 70%);
            border-radius: 50%;
            opacity: 0.7;
        }
        
        .nebula {
            position: absolute;
            border-radius: 50%;
            filter: blur(10px);
            opacity: 0.3;
        }
        
        /* Removed info panel as requested */
        
        .chat-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(25, 25, 50, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(100, 149, 237, 0.8);
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .chat-toggle:hover {
            background: rgba(100, 149, 237, 0.9);
            box-shadow: 0 0 20px rgba(100, 149, 237, 1);
            transform: scale(1.05);
        }
        
        /* Floating Chat Styles */
        .space-chat-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 350px;
            height: 450px;
            background: rgba(10, 15, 40, 0.7);
            border: 1px solid rgba(100, 149, 237, 0.7);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(100, 149, 237, 0.4);
            backdrop-filter: blur(5px);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .space-chat-container.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        
        .space-chat-header {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(100, 149, 237, 0.3);
            cursor: move;
        }
        
        .space-chat-title {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }
        
        .space-chat-controls {
            display: flex;
            gap: 8px;
        }
        
        .space-chat-control-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .space-chat-control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .space-chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .space-chat-message {
            padding: 10px 12px;
            border-radius: 12px;
            max-width: 80%;
            word-break: break-word;
            animation: message-fade-in 0.3s ease-out;
        }
        
        @keyframes message-fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .space-chat-user-message {
            align-self: flex-end;
            background: rgba(100, 149, 237, 0.4);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .space-chat-ai-message {
            align-self: flex-start;
            background: rgba(30, 30, 50, 0.6);
            color: white;
            border-bottom-left-radius: 4px;
        }
        
        .space-chat-system-message {
            align-self: center;
            background: rgba(150, 150, 150, 0.2);
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            font-size: 0.9em;
            padding: 6px 10px;
        }
        
        .space-chat-input-container {
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            background: rgba(20, 25, 50, 0.7);
            border-top: 1px solid rgba(100, 149, 237, 0.3);
        }
        
        .space-chat-input {
            flex: 1;
            background: rgba(30, 35, 60, 0.8);
            border: 1px solid rgba(100, 149, 237, 0.5);
            border-radius: 20px;
            color: white;
            padding: 10px 15px;
            outline: none;
            resize: none;
        }
        
        .space-chat-input:focus {
            border-color: rgba(100, 149, 237, 1);
            box-shadow: 0 0 8px rgba(100, 149, 237, 0.6);
        }
        
        .space-chat-send {
            background: rgba(100, 149, 237, 0.8);
            border: none;
            border-radius: 50%;
            color: white;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .space-chat-send:hover {
            background: rgba(100, 149, 237, 1);
            transform: scale(1.05);
        }
        
        .space-typing-indicator {
            display: flex;
            padding: 10px 12px;
            align-self: flex-start;
            background: rgba(30, 30, 50, 0.6);
            color: white;
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            margin-bottom: 5px;
        }
        
        .space-typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
            margin: 0 2px;
            animation: typing-dot 1.4s infinite ease-in-out;
        }
        
        .space-typing-dot:nth-child(1) { animation-delay: 0s; }
        .space-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .space-typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing-dot {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body>
    <div id="space-container">
        <!-- Galaxy arms -->
        <div class="galaxy-arm" style="width: 1000px; height: 400px; transform: translate(-50%, -50%) rotate(0deg);"></div>
        <div class="galaxy-arm" style="width: 1000px; height: 350px; transform: translate(-50%, -50%) rotate(72deg);"></div>
        <div class="galaxy-arm" style="width: 900px; height: 300px; transform: translate(-50%, -50%) rotate(144deg);"></div>
        <div class="galaxy-arm" style="width: 950px; height: 320px; transform: translate(-50%, -50%) rotate(216deg);"></div>
        <div class="galaxy-arm" style="width: 1000px; height: 380px; transform: translate(-50%, -50%) rotate(288deg);"></div>
        
        <!-- Nebulae -->
        <div class="nebula" style="width: 200px; height: 200px; top: 30%; left: 35%; background-color: rgba(237, 87, 87, 0.3);"></div>
        <div class="nebula" style="width: 150px; height: 150px; top: 60%; left: 55%; background-color: rgba(100, 149, 237, 0.3);"></div>
        <div class="nebula" style="width: 180px; height: 180px; top: 45%; left: 70%; background-color: rgba(162, 87, 237, 0.3);"></div>
        
        <!-- Minerva Orb - now clickable -->
        <div id="minerva-orb" style="cursor: pointer;">
            <div class="orb-highlight" style="position: absolute; width: 40px; height: 40px; top: 25%; left: 25%; background-color: rgba(255,255,255,0.3); border-radius: 50%;"></div>
        </div>
        
        <button class="chat-toggle">ðŸ’¬</button>
        
        <!-- Floating Chat Interface -->
        <div id="space-floating-chat" class="space-chat-container">
            <div class="space-chat-header">
                <div class="space-chat-title">
                    <i style="margin-right: 5px;">âœ¨</i> Minerva Assistant
                </div>
                <div class="space-chat-controls">
                    <button class="space-chat-control-btn" id="space-minimize-btn" title="Minimize">_</button>
                    <button class="space-chat-control-btn" id="space-close-btn" title="Close">Ã—</button>
                </div>
            </div>
            
            <div class="space-chat-messages" id="space-chat-messages">
                <!-- Welcome message -->
                <div class="space-chat-message space-chat-system-message">
                    Welcome to the Minerva Space Assistant. How can I help you explore today?
                </div>
            </div>
            
            <div class="space-chat-input-container">
                <textarea class="space-chat-input" id="space-chat-input" placeholder="Type your message here..."></textarea>
                <button class="space-chat-send" id="space-chat-send">
                    â†‘
                </button>
            </div>
        </div>
        
        <!-- Info panel removed as requested -->
    </div>

    <script>
        // Create stars dynamically
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('space-container');
            const minervaOrb = document.getElementById('minerva-orb');
            const numStars = 200;
            
            // Variables for zoom and pan
            let scale = 1;
            let viewOffsetX = 0;
            let viewOffsetY = 0;
            let startX, startY;
            let isViewDragging = false;
            
            // Apply transform to container elements
            function updateTransform() {
                // Apply transforms to all galaxy arms - only pan, no zoom
                document.querySelectorAll('.galaxy-arm').forEach(arm => {
                    const rotation = arm.getAttribute('data-rotation') || getRotationFromStyle(arm.style.transform);
                    arm.style.transform = `translate(calc(-50% + ${viewOffsetX}px), calc(-50% + ${viewOffsetY}px)) rotate(${rotation}deg)`;
                });
                
                // Apply transforms to all nebulae - only pan, no zoom
                document.querySelectorAll('.nebula').forEach(nebula => {
                    nebula.style.transform = `translate(${offsetX * 0.7}px, ${offsetY * 0.7}px)`;
                });
                
                // Apply transforms to stars - only pan, no zoom
                document.querySelectorAll('.star').forEach(star => {
                    star.style.transform = `translate(${offsetX * 0.5}px, ${offsetY * 0.5}px)`;
                });
                
                // Apply zoom ONLY to the Minerva orb
                minervaOrb.style.width = `${150 * scale}px`;
                minervaOrb.style.height = `${150 * scale}px`;
                minervaOrb.style.boxShadow = `0 0 ${50 * scale}px ${20 * scale}px rgba(74, 126, 231, 0.5),
                               0 0 ${100 * scale}px ${40 * scale}px rgba(74, 126, 231, 0.3)`;
                
                // Removed zoom level indicator as requested
            }
            
            // Extract rotation value from transform style
            function getRotationFromStyle(transformStyle) {
                const match = transformStyle.match(/rotate\(([0-9]+)deg\)/);
                return match ? match[1] : 0;
            }
            
            // Create stars
            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // Random size between 1-3px
                const size = Math.random() * 2 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                
                // Random position
                star.style.top = Math.random() * 100 + '%';
                star.style.left = Math.random() * 100 + '%';
                
                // Random animation delay
                star.style.animationDelay = Math.random() * 4 + 's';
                
                container.appendChild(star);
            }
            
            // Store original rotation values
            document.querySelectorAll('.galaxy-arm').forEach(arm => {
                const rotation = getRotationFromStyle(arm.style.transform);
                arm.setAttribute('data-rotation', rotation);
            });
            
            // Mouse wheel for zooming
            container.addEventListener('wheel', function(e) {
                e.preventDefault();
                const delta = e.deltaY * -0.01;
                scale = Math.max(0.1, Math.min(scale + delta, 3));
                updateTransform();
            });
            
            // Mouse down for panning
            container.addEventListener('mousedown', function(e) {
                if (e.target.className !== 'chat-toggle') {
                    isViewDragging = true;
                    startX = e.clientX - viewOffsetX;
                    startY = e.clientY - viewOffsetY;
                    container.style.cursor = 'grabbing';
                }
            });
            
            // Mouse move for panning
            container.addEventListener('mousemove', function(e) {
                if (isViewDragging) {
                    viewOffsetX = e.clientX - startX;
                    viewOffsetY = e.clientY - startY;
                    updateTransform();
                }
            });
            
            // Mouse up to stop panning
            container.addEventListener('mouseup', function() {
                isViewDragging = false;
                container.style.cursor = 'grab';
            });
            
            // Mouse leave to stop panning
            container.addEventListener('mouseleave', function() {
                isViewDragging = false;
                container.style.cursor = 'grab';
            });
            
            // Touch events for mobile
            container.addEventListener('touchstart', function(e) {
                if (e.target.className !== 'chat-toggle') {
                    isViewDragging = true;
                    startX = e.touches[0].clientX - viewOffsetX;
                    startY = e.touches[0].clientY - viewOffsetY;
                }
            });
            
            container.addEventListener('touchmove', function(e) {
                if (isViewDragging) {
                    e.preventDefault();
                    viewOffsetX = e.touches[0].clientX - startX;
                    viewOffsetY = e.touches[0].clientY - startY;
                    updateTransform();
                }
            });
            
            container.addEventListener('touchend', function() {
                isViewDragging = false;
            });
            
            // Initialize grab cursor
            container.style.cursor = 'grab';
            
            // Minerva orb click functionality
            minervaOrb.addEventListener('click', function() {
                window.location.href = '/minerva-portal';
            });
            
            // Chat toggle functionality
            const chatToggle = document.querySelector('.chat-toggle');
            const floatingChat = document.getElementById('space-floating-chat');
            const minimizeBtn = document.getElementById('space-minimize-btn');
            const closeBtn = document.getElementById('space-close-btn');
            const chatInput = document.getElementById('space-chat-input');
            const sendBtn = document.getElementById('space-chat-send');
            const messagesContainer = document.getElementById('space-chat-messages');
            
            console.log('Space Chat Elements:', {
                chatToggle: !!chatToggle,
                floatingChat: !!floatingChat,
                minimizeBtn: !!minimizeBtn,
                closeBtn: !!closeBtn,
                chatInput: !!chatInput,
                sendBtn: !!sendBtn,
                messagesContainer: !!messagesContainer
            });
            
            // Chat history and conversation tracking
            let spaceChatHistory = [];
            let spaceConversationId = null;
            
            // Load chat history from localStorage
            function loadSpaceChatHistory() {
                try {
                    const savedHistory = localStorage.getItem('space_chat_history');
                    if (savedHistory) {
                        spaceChatHistory = JSON.parse(savedHistory);
                        // Display saved messages
                        spaceChatHistory.forEach(msg => {
                            addSpaceMessage(msg.content, msg.sender, msg.modelInfo, false);
                        });
                    }
                    
                    spaceConversationId = localStorage.getItem('space_conversation_id');
                    console.log('Loaded space chat history and conversation ID:', spaceConversationId);
                } catch (error) {
                    console.error('Error loading chat history:', error);
                }
            }
            
            // Save chat history to localStorage
            function saveSpaceChatHistory() {
                localStorage.setItem('space_chat_history', JSON.stringify(spaceChatHistory));
                if (spaceConversationId) {
                    localStorage.setItem('space_conversation_id', spaceConversationId);
                }
            }
            
            // Add message to chat
            function addSpaceMessage(content, sender, modelInfo = null, saveToHistory = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `space-chat-message space-chat-${sender}-message`;
                messageDiv.textContent = content;
                
                // Add model info if available
                if (modelInfo && sender === 'ai') {
                    const modelInfoDiv = document.createElement('div');
                    modelInfoDiv.className = 'space-model-info';
                    modelInfoDiv.style.fontSize = '0.7em';
                    modelInfoDiv.style.opacity = '0.7';
                    modelInfoDiv.style.marginTop = '5px';
                    modelInfoDiv.textContent = `Model: ${modelInfo}`;
                    messageDiv.appendChild(modelInfoDiv);
                }
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Add to history array and save to localStorage
                if (saveToHistory && sender !== 'system') {
                    spaceChatHistory.push({
                        content: content,
                        sender: sender,
                        modelInfo: modelInfo,
                        timestamp: new Date().toISOString()
                    });
                    saveSpaceChatHistory();
                }
            }
            
            // Send message function
            function sendSpaceMessage() {
                console.log('sendSpaceMessage function called');
                const message = chatInput.value.trim();
                if (!message) {
                    console.log('No message to send');
                    return;
                }
                
                console.log('Sending space message:', message);
                
                // Add user message to chat
                addSpaceMessage(message, 'user');
                chatInput.value = '';
                
                // Focus back on input for continued conversation
                chatInput.focus();
                
                // Show typing indicator
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'space-typing-indicator';
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'space-typing-dot';
                    typingIndicator.appendChild(dot);
                }
                messagesContainer.appendChild(typingIndicator);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Send to API
                console.log('Sending to Think Tank API with conversation_id:', spaceConversationId);
                fetch('/api/think-tank', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: spaceConversationId,
                        context: {
                            type: 'space',
                            source: 'space_interface'
                        }
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Think Tank API response:', data);
                    console.log('Response type:', typeof data.response);
                    console.log('Response value:', data.response);
                    console.log('Has response property:', 'response' in data);
                    // Remove typing indicator
                    if (messagesContainer.contains(typingIndicator)) {
                        messagesContainer.removeChild(typingIndicator);
                    }
                    
                    if (data.response) {
                        // Add AI response - ensure it's always a string
                        let responseText = data.response;
                        
                        // Handle case where response might be an object
                        if (typeof responseText === 'object') {
                            try {
                                responseText = JSON.stringify(responseText);
                                console.log('Converted object response to string:', responseText);
                            } catch (e) {
                                console.error('Failed to stringify response object:', e);
                                responseText = 'Error: Could not display response properly';
                            }
                        }
                        
                        addSpaceMessage(responseText, 'ai', data.model_info);
                        
                        // Store conversation ID if provided
                        if (data.conversation_id) {
                            console.log('Received conversation_id:', data.conversation_id);
                            spaceConversationId = data.conversation_id;
                            saveSpaceChatHistory();
                        }
                    } else {
                        addSpaceMessage('Sorry, I encountered an error processing your request.', 'system');
                    }
                })
                .catch(error => {
                    console.error('API Error:', error);
                    
                    // Ensure typing indicator is removed even if there was an error
                    if (messagesContainer.contains(typingIndicator)) {
                        messagesContainer.removeChild(typingIndicator);
                    }
                    
                    // Show user-friendly error message with debug details in console
                    addSpaceMessage(`I encountered an error processing your request. Please try again.`, 'system');
                    
                    // Log detailed debugging information to help find the issue
                    console.log('Request payload:', {
                        message: message,
                        conversation_id: spaceConversationId,
                        context: {
                            type: 'space',
                            source: 'space_interface'
                        }
                    });
                });
            }
            
            // Toggle chat visibility when chat button is clicked
            chatToggle.addEventListener('click', function() {
                floatingChat.classList.toggle('active');
                if (floatingChat.classList.contains('active')) {
                    chatInput.focus();
                    loadSpaceChatHistory();
                }
            });
            
            // Close and minimize buttons
            closeBtn.addEventListener('click', function() {
                floatingChat.classList.remove('active');
            });
            
            minimizeBtn.addEventListener('click', function() {
                floatingChat.classList.remove('active');
            });
            
            // Make chat draggable
            const chatHeader = document.querySelector('.space-chat-header');
            let isChatDragging = false;
            let chatOffsetX, chatOffsetY;
            
            chatHeader.addEventListener('mousedown', function(e) {
                isChatDragging = true;
                chatOffsetX = e.clientX - floatingChat.getBoundingClientRect().left;
                chatOffsetY = e.clientY - floatingChat.getBoundingClientRect().top;
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isChatDragging) return;
                
                floatingChat.style.left = (e.clientX - chatOffsetX) + 'px';
                floatingChat.style.top = (e.clientY - chatOffsetY) + 'px';
                floatingChat.style.right = 'auto';
                floatingChat.style.bottom = 'auto';
            });
            
            document.addEventListener('mouseup', function() {
                isChatDragging = false;
            });
            
            // Send button click
            if (sendBtn) {
                console.log('Attaching click handler to space chat send button');
                sendBtn.addEventListener('click', function() {
                    console.log('Space chat send button clicked');
                    sendSpaceMessage();
                });
            } else {
                console.error('Space chat send button not found!');
            }
            
            // Enter key press with multiple methods to ensure it works
            if (chatInput) {
                console.log('Attaching keydown handler to space chat input field');
                
                // Remove any existing event listeners to prevent duplicates
                function handleSpaceKeyDown(e) {
                    console.log('Key pressed in space chat input field:', e.key, 'keyCode:', e.keyCode);
                    if ((e.key === 'Enter' || e.keyCode === 13) && !e.shiftKey) {
                        console.log('Enter key pressed in space chat, sending message');
                        e.preventDefault();
                        e.stopPropagation();
                        sendSpaceMessage();
                        return false;
                    }
                    return true;
                }
                
                // Attach both keydown and keypress handlers for better cross-browser support
                chatInput.addEventListener('keydown', handleSpaceKeyDown);
                chatInput.addEventListener('keypress', handleSpaceKeyDown);
                
                // Also directly inject an onkeydown attribute for maximum compatibility
                chatInput.setAttribute('onkeydown', 'if(event.key === "Enter" && !event.shiftKey) { event.preventDefault(); this.blur(); document.getElementById("space-chat-send").click(); return false; }');
            } else {
                console.error('Space chat input field not found!');
            }
        });
    </script>
</body>
</html>
