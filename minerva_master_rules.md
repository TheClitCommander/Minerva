# ðŸ§  Minerva Master Ruleset for Cascade Alignment

## Core System Rules (1-11)

1. **Progressive Enhancement Approach**:
   - Preserve existing functionality when introducing new features
   - Never break Think Tank's current implementation
   - Always test before removing any legacy features
   - Build incrementally and modularly

2. **Conversation Memory System Rules**:
   - Use `enhancedConversationStorage` as the primary memory store
   - Only fallback to `minervaMemory` or `window.conversationHistory` if explicitly requested
   - Implement context window optimization (prioritize recent messages, summarize older exchanges)
   - Ensure memory persists across reloads and runtime sessions unless manually cleared
   - Add clear fallback notices when memory fails to load

3. **Project Organization Rules**:
   - Every conversation must be convertible into a project
   - Projects must be assignable, editable, and searchable
   - Maintain context-awareness for conversations linked to specific projects

4. **API Connectivity Rules**:
   - Default port for API connections: 8080
   - If a bridge server is used (e.g., 8090), declare it in a config or variable â€” never infer dynamically
   - No usage of window.location.origin unless explicitly allowed
   - Graceful fallback if API fails (log error, simulate basic response, retry every 60 seconds)

5. **UI & Chat Interface Standards**:
   - Homepage chat must be floating with a transparency effect
   - Project-specific chat must be small, wide, and thin
   - All chats must be always visible, consistently styled, and responsive
   - Remove unused UI elements (e.g., theme toggle) if the user has disabled them

6. **Theme & Visual Consistency**:
   - Use CSS variables for theme (light/dark)
   - Only toggle themes when actual styles change (not just the icon)
   - Always apply theme to <html> and <body> elements
   - Ensure refreshChatTheme() works and is called after theme changes

7. **File & Module Structure**:
   - unified-chat-handler.js is the only chat handler to be used
   - Remove or archive files like direct-chat.js, floating-chat.js, chat.js, chat-core.js, etc.
   - Split logic across modules (memory storage, chat display, API bridge, UI rendering)

8. **Conversation Storage Standards**:
   - Save messages as objects: { role, content, model, timestamp }
   - Support tagging or linking messages to project IDs
   - Implement export/import to JSON (future support)

9. **Code Quality & Performance**:
   - Consistent naming conventions
   - Clean, modular functions
   - Comment complex logic
   - Avoid redundant operations
   - Reduce DOM manipulations where possible
   - Debounce excessive UI redraws (especially chat refresh)

10. **UX Principles**:
    - Provide visual feedback for all user actions
    - Always confirm when saving memory or linking projects
    - Never leave the user with a blank chat or unclear state
    - Errors should be user-friendly, not raw logs

11. **Rule Memory & Persistence**:
    - Cascade must permanently remember this ruleset
    - If any rule is ignored, log the reason in console.warn()
    - minerva_master_rules.md must be loaded and referenced before runtime changes
    - Do not alter these rules without explicit user instruction

## Enhanced Conversation & Dashboard Rules (12-20)

12. **Auto-link Conversations to Projects**:  
    - When a chat mentions a project by name (e.g., "Stitches in Casual"), auto-tag that chat to the project context
    - Update metadata when project references are detected
    - Support manual override of auto-linking

13. **Auto-generate Conversation Titles**:  
    - If not set manually, summarize the first 3â€“5 messages and assign as the default title
    - Flag auto-generated titles in metadata (autoGeneratedTitle: true)
    - Allow manual override at any time

14. **Sort Conversations by Recency**:  
    - Display most recent chats at the top of the dashboard unless manually pinned
    - Provide sort options (recency, project, importance)
    - Update sort order in real-time when new messages arrive

15. **Include Chat Summaries in Dashboard Hover Previews**:  
    - Show 1â€“2 sentence summary pulled from memory metadata when hovering over chat entries
    - Generate summaries dynamically if not available
    - Update previews based on latest content

16. **Ensure Cross-page Persistence**:  
    - Maintain chat window state and current conversation context when switching pages
    - Preserve scroll position and input content
    - Smoothly transition between home, project views, and back

17. **Prevent Message Duplicates on Refresh**:  
    - Check for existing DOM elements using message IDs or timestamps before rendering
    - Use deterministic rendering to prevent flickering or repositioning
    - Remove duplicate messages if detected

18. **Use a "chatMessageId" System**:  
    - Assign a unique ID to each message saved in memory
    - Format: timestamp-hash or incrementing sequence
    - Use IDs for direct linking, editing, and duplication prevention

19. **Store Session-level Metadata**:  
    - Include fields for each message:
        - `source` (fallback vs ThinkTank)
        - `timestamp` (ISO format)
        - `model` (e.g., GPT-4, Claude 3)
        - `projectContext` (if assigned)
        - `autoGeneratedTitle` (boolean)
        - `edited` (boolean, if message was edited)
        - `attachments` (array of attachment references)

20. **Implement Message-level Sync Markers**:  
    - Store a `synced: boolean` field for each message
    - Update once the message is saved to cloud memory
    - Use visual indicators to show sync status
    - Implement retry logic for failed syncs

---

_This ruleset is authoritative for Minerva development. All code changes should align with these principles. For exceptions, document the reason in code comments and console warnings._
